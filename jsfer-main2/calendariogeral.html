<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio Financeiro Unificado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- Base Styles (Combined & Refined) --- */
        :root {
            --primary-color-receipt: #5A9EDB; /* Blue for receipts */
            --primary-color-payment: #e74c3c; /* Red/Orange for payments */
            --primary-color-delivery: #9b59b6; /* Purple for deliveries */
            --success-color: #2ecc71; /* Green for paid/success */
            --warning-color: #f39c12; /* Yellow for pending/attention */
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #e2e8f0;
            --background-color: #f8f9fa; /* Light gray background */
            --card-background: #ffffff;
            --text-color: #333;
            --text-muted: #64748b;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            padding: 15px;
            color: var(--text-color);
            font-size: 15px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 600;
        }

        /* --- Filter Controls --- */
        .filter-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f1f5f9;
            border-radius: var(--border-radius);
        }

        .filter-controls button {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .filter-controls button.active {
            background-color: var(--dark-color);
            color: white;
            border-color: var(--dark-color);
        }
         .filter-controls button.filter-all.active { background-color: #6c757d; border-color: #6c757d; color:white;}
         .filter-controls button.filter-receipts.active { background-color: var(--primary-color-receipt); border-color: var(--primary-color-receipt); color:white;}
         .filter-controls button.filter-payments.active { background-color: var(--primary-color-payment); border-color: var(--primary-color-payment); color:white;}


        /* --- Resumo Section --- */
        .resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            background: #f1f5f9;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .resumo div {
            text-align: center;
        }

        .resumo span {
            display: block;
        }

        .resumo span:first-child { /* Value */
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .resumo span:last-child { /* Label */
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        #total-a-receber { color: var(--primary-color-receipt); }
        #total-recebido { color: var(--success-color); }
        #total-a-pagar { color: var(--primary-color-payment); }
        #total-pago { color: var(--success-color); }


        /* --- Calendar Controls & Grid --- */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .calendar-nav button {
            background: var(--dark-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calendar-nav button:hover { background: #555; }

        .month-year {
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--dark-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            padding: 8px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .day-cell {
            min-height: 90px; /* Increased height */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px;
            font-size: 0.85rem;
            background: var(--card-background);
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .day-cell:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            border-color: #aaa;
        }
        .day-cell.today { border: 2px solid var(--dark-color); }
        /* Status indicators (Subtle background colors) */
        .day-cell.has-past-due-receipt { background-color: #fff5f5; } /* Light red for overdue receipts */
        .day-cell.has-past-due-payment { background-color: #fff8f0; } /* Light orange for overdue payments */
        .day-cell.has-paid-items { background-color: #f0fdf4; } /* Light green for days with paid items */
        .day-cell.has-deliveries { background-color: #fbf5ff; } /* Light purple for days with deliveries */

        .day-number {
            font-weight: bold;
            margin-bottom: 4px;
            text-align: right;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .entry-indicators {
            margin-top: auto; /* Push indicators to the bottom */
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center; /* Center indicators */
            padding-top: 5px;
        }
        .indicator {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            font-size: 0.7rem;
            line-height: 18px;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        .indicator-receipt { background-color: var(--primary-color-receipt); }
        .indicator-payment { background-color: var(--primary-color-payment); }
        .indicator-delivery { background-color: var(--primary-color-delivery); }


        /* --- Buttons --- */
        .action-buttons {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 10px;
        }
        .action-buttons button {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-add { background-color: var(--success-color); color: white; }
        .btn-add:hover { background-color: #27ae60; }
        .btn-report { background-color: var(--dark-color); color: white; }
        .btn-report:hover { background-color: #555; }

        /* --- Modals (General Styles) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: var(--card-background);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 550px; /* Slightly wider default */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow-y: auto;
            position: relative; /* For close button positioning */
        }
         .modal-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding-bottom: 10px;
             border-bottom: 1px solid var(--border-color);
         }
         .modal-header h2 {
             margin: 0;
             color: var(--dark-color);
             font-size: 1.4rem;
         }
         .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
         }
         .modal-close-btn:hover { color: var(--dark-color); }

        .modal label {
            display: block;
            margin: 12px 0 5px 0;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .modal input[type="text"],
        .modal input[type="number"],
        .modal input[type="date"],
        .modal select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border 0.2s, box-shadow 0.2s;
        }
        .modal input:focus, .modal select:focus {
            outline: none;
            border-color: var(--primary-color-receipt); /* Default focus color */
            box-shadow: 0 0 0 3px rgba(90, 158, 219, 0.15);
        }
        /* Specific focus colors if needed */
         .modal.payment-modal input:focus, .modal.payment-modal select:focus {
             border-color: var(--primary-color-payment);
             box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.15);
         }


        .modal-buttons {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .modal-buttons button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .btn-save { background-color: var(--success-color); color: white; }
        .btn-save:hover { background-color: #27ae60; }
        .btn-cancel { background-color: var(--text-muted); color: white; }
        .btn-cancel:hover { background-color: #555; }
        .btn-delete { background-color: var(--primary-color-payment); color: white; }
        .btn-delete:hover { background-color: #c0392b; }


        /* --- Day Details Modal --- */
        .day-details-content { max-width: 600px; }
        #day-entries-list { margin-top: 15px; }
        .day-entry {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: #f8fafc;
            box-shadow: var(--shadow-sm);
            border-left: 5px solid; /* Default border */
            position: relative;
        }
         /* Specific styling per entry type */
         .day-entry.receipt { border-left-color: var(--primary-color-receipt); }
         .day-entry.payment { border-left-color: var(--primary-color-payment); }
         .day-entry.delivery { border-left-color: var(--primary-color-delivery); }

         .day-entry.paid, .day-entry.delivered {
            background-color: #f0fdf4; /* Light green background for completed items */
             border-left-color: var(--success-color) !important;
        }
        .day-entry.past-due {
            background-color: #fff5f5; /* Light red/orange for past due */
             /* Keep original border color for type distinction unless paid */
        }
        .day-entry h3 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
         .day-entry h3 i { /* Icon before title */
            font-size: 1rem;
         }
         .day-entry.receipt h3 i { color: var(--primary-color-receipt); }
         .day-entry.payment h3 i { color: var(--primary-color-payment); }
         .day-entry.delivery h3 i { color: var(--primary-color-delivery); }

        .day-entry p { margin: 5px 0; font-size: 0.9rem; color: var(--text-muted); }
        .day-entry p strong { color: var(--dark-color); font-weight: 500; }
        .entry-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }
        .entry-actions button {
            border: none;
            padding: 7px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex: 0 1 auto; /* Allow shrinking but not growing */
        }
        .btn-action-paid { background-color: var(--success-color); color: white; }
        .btn-action-paid:hover { background-color: #27ae60; }
        .btn-action-delivered { background-color: var(--success-color); color: white; }
        .btn-action-delivered:hover { background-color: #27ae60; }
        .btn-action-whatsapp { background-color: #25D366; color: white; }
        .btn-action-whatsapp:hover { background-color: #1da851; }
        .btn-action-edit { background-color: #3b82f6; color: white; }
        .btn-action-edit:hover { background-color: #2563eb; }
        .btn-action-delete { background-color: var(--primary-color-payment); color: white; }
        .btn-action-delete:hover { background-color: #c0392b; }

        /* --- Combined Report Modal --- */
        .report-modal .modal-content { max-width: 700px; }
        #report-summary, #report-details { margin-top: 15px; }
        .report-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
         .report-section:last-child { border-bottom: none; margin-bottom: 0; }
         .report-section h3 { margin-bottom: 10px; font-size: 1.1rem; color: var(--dark-color); }
         .report-totals p { margin: 6px 0; font-size: 1rem; }
         .report-totals .value { font-weight: bold; }
         .report-totals .receipt-total { color: var(--primary-color-receipt); }
         .report-totals .payment-total { color: var(--primary-color-payment); }
         .report-totals .balance-positive { color: var(--success-color); font-size: 1.1rem; }
         .report-totals .balance-negative { color: var(--primary-color-payment); font-size: 1.1rem; }
         #report-details ul { list-style: none; padding: 0; }
         #report-details li {
             padding: 10px;
             margin-bottom: 8px;
             border-radius: 6px;
             background-color: #f8f9fa;
             display: flex;
             justify-content: space-between;
             align-items: center;
             font-size: 0.9rem;
             border-left: 4px solid;
         }
         #report-details li.receipt { border-left-color: var(--primary-color-receipt); }
         #report-details li.payment { border-left-color: var(--primary-color-payment); }
         #report-details li span:last-child { font-weight: bold; }


        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.4rem; }
            .resumo { grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
            .resumo span:first-child { font-size: 1rem; }
            .resumo span:last-child { font-size: 0.7rem; }
            .calendar-grid { gap: 4px; }
            .day-cell { min-height: 75px; padding: 4px; }
            .day-number { font-size: 0.8rem; }
            .indicator { width: 15px; height: 15px; line-height: 15px; font-size: 0.65rem; }
            .action-buttons { grid-template-columns: 1fr; } /* Stack buttons */
             .modal-content { padding: 20px; }
             .modal-header h2 { font-size: 1.2rem; }
             .entry-actions button { font-size: 0.75rem; padding: 6px 10px; }
             #report-details li { flex-direction: column; align-items: flex-start; gap: 5px; }
        }
        @media (max-width: 480px) {
            body { padding: 10px; }
            .filter-controls { flex-wrap: wrap; justify-content: center; }
            .filter-controls button { flex-grow: 1; font-size: 0.85rem; }
            .resumo { grid-template-columns: 1fr; } /* Stack summary items */
            .calendar-nav button { padding: 6px 10px; font-size: 0.9rem; }
            .month-year { font-size: 1.1rem; }
            .day-header { font-size: 0.7rem; padding: 6px 0; }
            .day-cell { min-height: 65px; }
            .indicator { width: 12px; height: 12px; line-height: 12px; font-size: 0.6rem; }
            .action-buttons button { font-size: 0.9rem; }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Calend√°rio Financeiro Unificado</h1>

        <div class="filter-controls">
            <button id="filter-all" class="active filter-all" data-filter="all">üìÖ Tudo</button>
            <button id="filter-receipts" class="filter-receipts" data-filter="receipt">üí∞ Recebimentos</button>
            <button id="filter-payments" class="filter-payments" data-filter="payment">üí∏ Pagamentos</button>
             <button id="filter-deliveries" class="filter-deliveries" data-filter="delivery">üöö Entregas</button>
        </div>

        <div class="resumo">
            <div>
                <span id="total-a-receber">R$ 0,00</span>
                <span>A Receber (M√™s)</span>
            </div>
            <div>
                <span id="total-recebido">R$ 0,00</span>
                <span>Recebido (M√™s)</span>
            </div>
            <div>
                <span id="total-a-pagar">R$ 0,00</span>
                <span>A Pagar (M√™s)</span>
            </div>
            <div>
                <span id="total-pago">R$ 0,00</span>
                <span>Pago (M√™s)</span>
            </div>
        </div>

        <div class="calendar-nav">
            <button id="prev-month" title="M√™s Anterior"><i class="fas fa-chevron-left"></i></button>
            <div class="month-year" id="current-month">M√™s Ano</div>
            <button id="next-month" title="Pr√≥ximo M√™s"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="calendar-grid" id="calendar-header">
            <div class="day-header">Dom</div>
            <div class="day-header">Seg</div>
            <div class="day-header">Ter</div>
            <div class="day-header">Qua</div>
            <div class="day-header">Qui</div>
            <div class="day-header">Sex</div>
            <div class="day-header">S√°b</div>
        </div>

        <div class="calendar-grid" id="calendar-days">
            </div>

        <div class="action-buttons">
            <button class="btn-add" id="open-add-entry-modal"><i class="fas fa-plus-circle"></i> Adicionar Lan√ßamento</button>
            <button class="btn-report" id="open-report-modal"><i class="fas fa-chart-pie"></i> Relat√≥rio do M√™s</button>
        </div>
    </div>

    <div class="modal" id="entry-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="entry-modal-title">Novo Lan√ßamento</h2>
                <button class="modal-close-btn" data-close-modal>&times;</button>
            </div>
            <form id="entry-form">
                <input type="hidden" id="entry-id"> <label for="entry-type">Tipo de Lan√ßamento</label>
                <select id="entry-type" required>
                    <option value="receipt" selected>Recebimento</option>
                    <option value="payment">Pagamento</option>
                </select>

                <label for="entry-description">Descri√ß√£o</label>
                <input type="text" id="entry-description" required>

                <label for="entry-value">Valor (R$)</label>
                <input type="number" id="entry-value" step="0.01" required>

                <label for="entry-date">Data Vencimento/Pagamento</label>
                <input type="date" id="entry-date" required>

                <div id="receipt-fields">
                    <label for="entry-client">Cliente (opcional)</label>
                    <select id="entry-client">
                        <option value="">Selecione...</option>
                        </select>
                </div>

                <div id="payment-fields" style="display: none;">
                    <label for="entry-supplier">Fornecedor (opcional)</label>
                    <input type="text" id="entry-supplier">

                    <label for="entry-supplier-contact">Contato/Detalhes (opcional)</label>
                    <input type="text" id="entry-supplier-contact">

                     <label for="entry-recurrence">Recorr√™ncia</label>
                     <select id="entry-recurrence">
                         <option value="none">N√£o repete</option>
                         <option value="weekly">Semanal</option>
                         <option value="monthly">Mensal</option>
                     </select>
                </div>


                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" data-close-modal>Cancelar</button>
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="day-details-modal">
        <div class="modal-content day-details-content">
            <div class="modal-header">
                 <h2 id="day-details-title">Detalhes do Dia</h2>
                <button class="modal-close-btn" data-close-modal>&times;</button>
            </div>
            <div id="day-entries-list">
                </div>
             <div class="modal-buttons">
                  <button type="button" class="btn-cancel" data-close-modal>Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal report-modal" id="report-modal">
        <div class="modal-content">
             <div class="modal-header">
                 <h2 id="report-title">Relat√≥rio Mensal</h2>
                 <button class="modal-close-btn" data-close-modal>&times;</button>
             </div>

            <div id="report-content">
                <div class="report-section report-totals">
                     <h3>Resumo Financeiro do M√™s</h3>
                     <p>Total Recebido: <span class="value receipt-total" id="report-total-received">R$ 0,00</span></p>
                     <p>Total Pago: <span class="value payment-total" id="report-total-paid">R$ 0,00</span></p>
                     <p>Saldo: <span class="value" id="report-balance">R$ 0,00</span></p>
                 </div>
                 <div class="report-section">
                    <h3>Detalhes dos Lan√ßamentos</h3>
                    <ul id="report-details">
                         </ul>
                 </div>
            </div>
             <div class="modal-buttons">
                 <button type="button" class="btn-cancel" data-close-modal>Fechar</button>
             </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, query, orderBy, deleteDoc, where, Timestamp, writeBatch, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        // !!! REPLACE WITH YOUR ACTUAL FIREBASE CONFIGURATION !!!
        const firebaseConfig = {
            apiKey: "AIzaSyCVkb1-tdd5SL8jA2Cw2B0aeugu8SaCUBc", // Example key, replace it
            authDomain: "testebosspro.firebaseapp.com",
            projectId: "testebosspro",
            storageBucket: "testebosspro.appspot.com",
            messagingSenderId: "73684788134",
            appId: "1:73684788134:web:7c8250c83f10a2df59e567",
            measurementId: "G-1H29L5B830"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State Variables ---
        let currentDate = new Date();
        let allEntries = []; // Combined list of receipts, payments, and deliveries
        let clients = []; // Cache for client data
        let currentFilter = 'all'; // 'all', 'receipt', 'payment', 'delivery'

        // --- DOM Element References ---
        const calendarDaysEl = document.getElementById('calendar-days');
        const currentMonthEl = document.getElementById('current-month');
        const prevMonthBtnEl = document.getElementById('prev-month');
        const nextMonthBtnEl = document.getElementById('next-month');
        const entryModalEl = document.getElementById('entry-modal');
        const openModalBtnEl = document.getElementById('open-add-entry-modal');
        const entryFormEl = document.getElementById('entry-form');
        const entryModalTitleEl = document.getElementById('entry-modal-title');
        const entryTypeSelectEl = document.getElementById('entry-type');
        const receiptFieldsEl = document.getElementById('receipt-fields');
        const paymentFieldsEl = document.getElementById('payment-fields');
        const entryClientSelectEl = document.getElementById('entry-client');
        const entryIdInputEl = document.getElementById('entry-id');
        const totalAReceberEl = document.getElementById('total-a-receber');
        const totalRecebidoEl = document.getElementById('total-recebido');
        const totalAPagarEl = document.getElementById('total-a-pagar');
        const totalPagoEl = document.getElementById('total-pago');
        const dayDetailsModalEl = document.getElementById('day-details-modal');
        const dayDetailsTitleEl = document.getElementById('day-details-title');
        const dayEntriesListEl = document.getElementById('day-entries-list');
        const reportModalEl = document.getElementById('report-modal');
        const reportTitleEl = document.getElementById('report-title');
        const reportTotalReceivedEl = document.getElementById('report-total-received');
        const reportTotalPaidEl = document.getElementById('report-total-paid');
        const reportBalanceEl = document.getElementById('report-balance');
        const reportDetailsListEl = document.getElementById('report-details');
        const filterButtons = document.querySelectorAll('.filter-controls button');
        const openReportModalBtnEl = document.getElementById('open-report-modal');


        // --- Utility Functions ---
        function formatCurrency(value) {
            if (isNaN(value)) return 'R$ 0,00';
            return `R$ ${Number(value).toFixed(2).replace('.', ',')}`;
        }

        function formatDate(dateString) { // Input YYYY-MM-DD
            if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

         function parseDate(dateString) { // Input YYYY-MM-DD -> Date object (UTC midnight)
            if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return null;
            const [year, month, day] = dateString.split('-');
            // Create date in UTC to avoid timezone issues when comparing dates
            return new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day)));
        }

        function toISODateString(date) { // Input Date object -> YYYY-MM-DD
            if (!date || !(date instanceof Date)) return '';
             const year = date.getFullYear();
             const month = (date.getMonth() + 1).toString().padStart(2, '0');
             const day = date.getDate().toString().padStart(2, '0');
             return `${year}-${month}-${day}`;
        }

        function getMonthName(monthIndex) {
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[monthIndex];
        }

        function createEmptyDayElement() {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'day-cell';
            emptyDay.style.visibility = 'hidden';
            emptyDay.style.pointerEvents = 'none';
            return emptyDay;
        }

        // Adjust date for Firestore (ensure YYYY-MM-DD)
        function adjustDateForFirestore(dateString) {
            if (!dateString) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString; // Already correct format
            }
            try {
                // Attempt to parse potentially different input formats (e.g., from date picker)
                const date = new Date(dateString + 'T00:00:00'); // Assume local time if not YYYY-MM-DD
                if (!isNaN(date.getTime())) {
                    return toISODateString(date); // Convert to YYYY-MM-DD
                }
            } catch (e) { console.error("Erro ao ajustar data para Firestore:", dateString, e); }
            return null; // Return null if parsing fails
        }


        // --- Data Loading Functions ---

        async function loadClients() {
            try {
                const q = query(collection(db, "clientes"), orderBy("empresa"), orderBy("nome"));
                const querySnapshot = await getDocs(q);
                clients = [];
                entryClientSelectEl.innerHTML = '<option value="">Selecione...</option>'; // Reset dropdown

                querySnapshot.forEach((doc) => {
                    const client = { id: doc.id, ...doc.data() };
                    clients.push(client);
                    const option = document.createElement('option');
                    // Store necessary info directly in the value for easy retrieval
                    option.value = JSON.stringify({
                        id: client.id,
                        nome: client.empresa || client.nome || 'Cliente Desconhecido',
                        telefone: client.telefone || ''
                    });
                    option.textContent = `${client.empresa || client.nome || 'Cliente Desconhecido'} (${client.codigo || 'S/C'})`;
                    entryClientSelectEl.appendChild(option);
                });
                console.log("Clientes carregados:", clients.length);
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
                // Consider adding UI feedback
            }
        }

         async function loadEntries() {
            console.log("Iniciando carregamento de todos os lan√ßamentos...");
            allEntries = []; // Clear previous entries
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const currentMonthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const futureMonthsLimit = 12; // How many months ahead to generate recurring payments
            const limitDate = new Date(today.getFullYear(), today.getMonth() + futureMonthsLimit, 0); // Generate up to end of the limit month


            try {
                // 1. Load Receipts
                const receiptsQuery = query(collection(db, "recebimentos"), orderBy("dataPagamento"));
                const receiptsSnapshot = await getDocs(receiptsQuery);
                receiptsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.dataPagamento && typeof data.dataPagamento === 'string') {
                        allEntries.push({
                            id: doc.id,
                            type: 'receipt', // Add type identifier
                            description: data.descricao || "Recebimento sem descri√ß√£o",
                            value: data.valor || 0,
                            date: data.dataPagamento, // YYYY-MM-DD
                            clientId: data.clienteId || null,
                            clientName: data.clienteNome || null,
                            clientPhone: data.telefone || null,
                            isPaid: data.pago || false,
                            isRecurring: false, // Receipts are not recurring in this model
                            createdAt: data.createdAt?.toDate() || new Date()
                        });
                    } else {
                        console.warn("Recebimento ignorado (data inv√°lida):", doc.id, data.dataPagamento);
                    }
                });
                console.log(`Carregados ${receiptsSnapshot.size} recebimentos.`);

                // 2. Load Original Payments & Generate Recurring Instances
                const paymentsQuery = query(collection(db, "pagamentos"), orderBy("dataPagamento"));
                const paymentsSnapshot = await getDocs(paymentsQuery);
                const originalPayments = []; // Store originals to generate future ones

                 paymentsSnapshot.forEach(doc => {
                    const data = doc.data();
                     if (data.dataPagamento && typeof data.dataPagamento === 'string') {
                        const paymentData = {
                            id: doc.id,
                            type: 'payment',
                            description: data.descricao || "Pagamento sem descri√ß√£o",
                            value: data.valor || 0,
                            date: data.dataPagamento, // YYYY-MM-DD
                            supplier: data.fornecedor || null,
                            supplierContact: data.contatoFornecedor || null,
                            isPaid: data.pago || false,
                            recurrence: data.recorrencia || 'none', // 'none', 'weekly', 'monthly'
                            isRecurring: data.recorrencia !== 'none',
                            createdAt: data.createdAt?.toDate() || new Date()
                        };
                        allEntries.push(paymentData); // Add the original payment
                        if (paymentData.isRecurring) {
                             originalPayments.push(paymentData); // Keep recurring originals for generation
                        }
                    } else {
                        console.warn("Pagamento ignorado (data inv√°lida):", doc.id, data.dataPagamento);
                    }
                 });
                console.log(`Carregados ${paymentsSnapshot.size} pagamentos originais.`);

                // Generate future instances for recurring payments
                originalPayments.forEach(origPayment => {
                    let nextDate = parseDate(origPayment.date);
                     if (!nextDate) {
                         console.warn(`N√£o foi poss√≠vel gerar recorr√™ncias para ${origPayment.id} devido √† data inv√°lida.`);
                         return;
                     }

                    let generatedCount = 0;
                    const maxGenerated = futureMonthsLimit * (origPayment.recurrence === 'weekly' ? 5 : 1); // Limit generation count

                    while (generatedCount < maxGenerated) {
                        // Calculate next occurrence date
                        if (origPayment.recurrence === 'weekly') {
                            nextDate.setUTCDate(nextDate.getUTCDate() + 7);
                        } else if (origPayment.recurrence === 'monthly') {
                            const originalDay = parseDate(origPayment.date).getUTCDate(); // Get day from original date
                             nextDate.setUTCMonth(nextDate.getUTCMonth() + 1);
                            // Adjust if month changed day (e.g., Jan 31 -> Feb 28)
                            // Set day explicitly to handle month length differences
                             nextDate = new Date(Date.UTC(nextDate.getUTCFullYear(), nextDate.getUTCMonth(), originalDay));
                        } else {
                            break; // Should not happen if isRecurring is true, but safety break
                        }

                        // Stop if next date exceeds the generation limit
                        if (nextDate > limitDate) break;

                        // Add the generated instance (only if it's on or after today)
                         // *** Correction: Generate all future instances within the limit ***
                         // We filter *display* later, but need all generated instances for accurate future view
                         // if (nextDate >= today) { // -- REMOVED THIS FILTER --
                            allEntries.push({
                                id: `gen-${origPayment.id}-${toISODateString(nextDate)}`, // Unique ID for generated
                                originalId: origPayment.id, // Link to original
                                type: 'payment',
                                description: origPayment.description,
                                value: origPayment.value,
                                date: toISODateString(nextDate),
                                supplier: origPayment.supplier,
                                supplierContact: origPayment.supplierContact,
                                isPaid: false, // Generated are always initially unpaid
                                recurrence: 'none', // Generated instances don't recur themselves
                                isRecurring: false,
                                isGenerated: true, // Flag as generated
                                createdAt: origPayment.createdAt // Inherit original creation time for context
                            });
                        // } // -- REMOVED THIS FILTER --
                        generatedCount++;
                    }
                });
                console.log("Inst√¢ncias de pagamento recorrentes geradas.");


                // 3. Load Deliveries (from 'pedidos')
                const deliveriesQuery = query(collection(db, "pedidos"), where("dataEntregaOficial", "!=", null)); // Only those with a date
                const deliveriesSnapshot = await getDocs(deliveriesQuery);
                 deliveriesSnapshot.forEach(doc => {
                    const data = doc.data();
                     // Ensure dataEntregaOficial exists and is likely in YYYY-MM-DD format
                     if (data.dataEntregaOficial && typeof data.dataEntregaOficial === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(data.dataEntregaOficial)) {
                        allEntries.push({
                            id: doc.id, // Use pedido ID
                            type: 'delivery',
                            description: `Entrega Pedido #${data.numeroPedido || doc.id.substring(0, 6).toUpperCase()}`,
                            date: data.dataEntregaOficial,
                            clientName: data.clienteNome || clients.find(c => c.id === data.clienteId)?.nome || 'Cliente Desconhecido',
                            value: data.totalGeral || 0, // Optional: include order value if needed
                            isDelivered: data.entregue || false, // Use 'entregue' field
                            isRecurring: false,
                            // Add other relevant fields from 'pedidos' if needed
                             numeroPedido: data.numeroPedido || null,
                             clienteId: data.clienteId || null,
                             orcamentoId: data.orcamentoId || null
                        });
                    } else {
                        console.warn("Pedido ignorado para entrega (data inv√°lida/ausente):", doc.id, data.dataEntregaOficial);
                    }
                 });
                console.log(`Carregadas ${deliveriesSnapshot.size} entregas.`);


                // Sort all entries by date after loading all types
                allEntries.sort((a, b) => {
                    const dateA = parseDate(a.date)?.getTime() || 0;
                    const dateB = parseDate(b.date)?.getTime() || 0;
                    if (dateA !== dateB) {
                        return dateA - dateB;
                    }
                    // Optional: secondary sort (e.g., by type or description) if dates are equal
                    return a.description.localeCompare(b.description);
                });

                console.log("Total de lan√ßamentos carregados e ordenados:", allEntries.length);
                updateCalendar(); // Update UI after loading everything

            } catch (error) {
                console.error("Erro geral ao carregar lan√ßamentos:", error);
                // Display error to user?
            }
        }


        // --- Calendar UI Update Functions ---

        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); // 0-indexed

            currentMonthEl.textContent = `${getMonthName(month)} ${year}`;
            calendarDaysEl.innerHTML = ''; // Clear previous days

            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));
            const startDayOfWeek = firstDayOfMonth.getUTCDay(); // 0=Sun, 1=Mon,...
            const totalDaysInMonth = lastDayOfMonth.getUTCDate();

            // Add empty cells for days before the 1st of the month
            for (let i = 0; i < startDayOfWeek; i++) {
                calendarDaysEl.appendChild(createEmptyDayElement());
            }

            const today = new Date(); today.setHours(0, 0, 0, 0);
            const todayUTCString = toISODateString(new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate())));

            // Add cells for each day of the month
            for (let day = 1; day <= totalDaysInMonth; day++) {
                const currentDayDate = new Date(Date.UTC(year, month, day));
                const dateString = toISODateString(currentDayDate);

                // Filter entries for the current day AND current filter selection
                const dayEntries = allEntries.filter(entry =>
                    entry.date === dateString &&
                    (currentFilter === 'all' || entry.type === currentFilter)
                );

                const dayElement = document.createElement('div');
                dayElement.className = 'day-cell';
                dayElement.dataset.date = dateString; // Store date for click handling

                // Highlight today
                if (dateString === todayUTCString) {
                    dayElement.classList.add('today');
                }

                // --- Add status classes based on ALL entries for the day (ignoring filter for status styling) ---
                const allDayEntriesUnfiltered = allEntries.filter(entry => entry.date === dateString);
                 let hasPaid = false;
                 let hasPastDueReceipt = false;
                 let hasPastDuePayment = false;
                 let hasDelivery = false;

                 allDayEntriesUnfiltered.forEach(entry => {
                     const entryDate = parseDate(entry.date);
                     const isPast = entryDate < today;
                     if (entry.type === 'receipt') {
                         if (entry.isPaid) hasPaid = true;
                         if (!entry.isPaid && isPast) hasPastDueReceipt = true;
                     } else if (entry.type === 'payment') {
                         if (entry.isPaid) hasPaid = true;
                         if (!entry.isPaid && isPast) hasPastDuePayment = true;
                     } else if (entry.type === 'delivery') {
                         hasDelivery = true;
                         if (entry.isDelivered) hasPaid = true; // Consider delivered as 'paid' for styling
                         // Could add past-due styling for deliveries if needed
                     }
                 });

                 if (hasPastDueReceipt) dayElement.classList.add('has-past-due-receipt');
                 if (hasPastDuePayment) dayElement.classList.add('has-past-due-payment');
                 if (hasPaid && !hasPastDueReceipt && !hasPastDuePayment) dayElement.classList.add('has-paid-items'); // Only green if nothing is overdue
                 if (hasDelivery) dayElement.classList.add('has-deliveries');
                // --- End of status class logic ---


                // Add day number
                const dayNumberEl = document.createElement('div');
                dayNumberEl.className = 'day-number';
                dayNumberEl.textContent = day;
                dayElement.appendChild(dayNumberEl);

                // Add indicators container
                const indicatorsEl = document.createElement('div');
                indicatorsEl.className = 'entry-indicators';

                 // Add indicators based on FILTERED entries for the day
                 const counts = { receipt: 0, payment: 0, delivery: 0 };
                 dayEntries.forEach(entry => {
                     if (counts[entry.type] !== undefined) {
                         counts[entry.type]++;
                     }
                 });

                if (counts.receipt > 0) indicatorsEl.innerHTML += `<span class="indicator indicator-receipt" title="${counts.receipt} Recebimento(s)">${counts.receipt}</span>`;
                if (counts.payment > 0) indicatorsEl.innerHTML += `<span class="indicator indicator-payment" title="${counts.payment} Pagamento(s)">${counts.payment}</span>`;
                if (counts.delivery > 0) indicatorsEl.innerHTML += `<span class="indicator indicator-delivery" title="${counts.delivery} Entrega(s)">${counts.delivery}</span>`;


                if (indicatorsEl.children.length > 0) {
                    dayElement.appendChild(indicatorsEl);
                }


                // Add click listener to show details
                dayElement.addEventListener('click', () => {
                    showDayDetails(dateString);
                });

                calendarDaysEl.appendChild(dayElement);
            }

            // Add empty cells for days after the end of the month
            const totalCells = startDayOfWeek + totalDaysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarDaysEl.appendChild(createEmptyDayElement());
            }

            updateSummary(); // Update financial summary after calendar renders
        }

        function updateSummary() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); // 0-indexed

            let totalAReceber = 0, totalRecebido = 0, totalAPagar = 0, totalPago = 0;

            allEntries.forEach(entry => {
                const entryDate = parseDate(entry.date);
                if (entryDate && entryDate.getUTCFullYear() === year && entryDate.getUTCMonth() === month) {
                    if (entry.type === 'receipt') {
                        if (entry.isPaid) {
                            totalRecebido += entry.value;
                        } else {
                            totalAReceber += entry.value;
                        }
                    } else if (entry.type === 'payment') {
                        if (entry.isPaid) {
                            totalPago += entry.value;
                        } else {
                            totalAPagar += entry.value;
                        }
                    }
                    // Deliveries don't contribute to the financial summary directly here
                }
            });

            totalAReceberEl.textContent = formatCurrency(totalAReceber);
            totalRecebidoEl.textContent = formatCurrency(totalRecebido);
            totalAPagarEl.textContent = formatCurrency(totalAPagar);
            totalPagoEl.textContent = formatCurrency(totalPago);
        }


        // --- Modal Handling ---

        function openEntryModal(entry = null) { // Pass entry data for editing
            entryFormEl.reset(); // Clear form
            entryIdInputEl.value = ''; // Clear hidden ID
            entryClientSelectEl.value = ''; // Reset client dropdown
            document.getElementById('entry-supplier').value = '';
            document.getElementById('entry-supplier-contact').value = '';
            document.getElementById('entry-recurrence').value = 'none';

            if (entry) { // Editing existing entry
                entryModalTitleEl.textContent = `Editar ${entry.type === 'receipt' ? 'Recebimento' : 'Pagamento'}`;
                entryIdInputEl.value = entry.id;
                entryTypeSelectEl.value = entry.type;
                document.getElementById('entry-description').value = entry.description;
                document.getElementById('entry-value').value = entry.value;
                document.getElementById('entry-date').value = entry.date; // Assumes YYYY-MM-DD

                if (entry.type === 'receipt') {
                    receiptFieldsEl.style.display = 'block';
                    paymentFieldsEl.style.display = 'none';
                    // Find and select the client in the dropdown
                     const clientOptionValue = JSON.stringify({ id: entry.clientId, nome: entry.clientName, telefone: entry.clientPhone });
                     // Find the option whose value matches the stringified object
                     const matchingOption = Array.from(entryClientSelectEl.options).find(opt => opt.value === clientOptionValue);
                     if(matchingOption) {
                         entryClientSelectEl.value = matchingOption.value;
                     } else {
                         entryClientSelectEl.value = ""; // Reset if client not found (or null)
                     }

                } else if (entry.type === 'payment') {
                    receiptFieldsEl.style.display = 'none';
                    paymentFieldsEl.style.display = 'block';
                    document.getElementById('entry-supplier').value = entry.supplier || '';
                    document.getElementById('entry-supplier-contact').value = entry.supplierContact || '';
                     // For recurring payments, editing the original sets the recurrence
                     // For generated instances, recurrence is 'none' and disabled
                     document.getElementById('entry-recurrence').value = entry.recurrence || 'none';
                     document.getElementById('entry-recurrence').disabled = !!entry.isGenerated; // Disable recurrence for generated
                }
                 entryTypeSelectEl.disabled = true; // Don't allow changing type when editing

            } else { // Adding new entry
                entryModalTitleEl.textContent = 'Novo Lan√ßamento';
                const today = new Date();
                document.getElementById('entry-date').value = toISODateString(today); // Default to today
                 entryTypeSelectEl.value = 'receipt'; // Default to receipt
                 receiptFieldsEl.style.display = 'block'; // Show receipt fields by default
                 paymentFieldsEl.style.display = 'none'; // Hide payment fields by default
                 entryTypeSelectEl.disabled = false; // Allow changing type when adding
                 document.getElementById('entry-recurrence').disabled = false;
            }

            toggleEntryFields(); // Ensure correct fields are visible based on type
            entryModalEl.style.display = 'flex';
        }

        function closeEntryModal() {
            entryModalEl.style.display = 'none';
        }

         function toggleEntryFields() {
             const selectedType = entryTypeSelectEl.value;
             const isEditingGenerated = !!entryIdInputEl.value && allEntries.find(e => e.id === entryIdInputEl.value)?.isGenerated;

             if (selectedType === 'receipt') {
                 receiptFieldsEl.style.display = 'block';
                 paymentFieldsEl.style.display = 'none';
             } else if (selectedType === 'payment') {
                 receiptFieldsEl.style.display = 'none';
                 paymentFieldsEl.style.display = 'block';
                 // Disable recurrence select if editing a generated payment instance
                 document.getElementById('entry-recurrence').disabled = isEditingGenerated;
             } else {
                 receiptFieldsEl.style.display = 'none';
                 paymentFieldsEl.style.display = 'none';
             }
         }


         function showDayDetails(dateString) {
            const date = parseDate(dateString);
            if (!date) return;

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
            dayDetailsTitleEl.textContent = `Detalhes para ${date.toLocaleDateString('pt-BR', options)}`;
            dayEntriesListEl.innerHTML = ''; // Clear previous list

             // Get ALL entries for the day, regardless of the current filter
             const dayEntriesAllTypes = allEntries.filter(entry => entry.date === dateString);

            if (dayEntriesAllTypes.length === 0) {
                dayEntriesListEl.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Nenhum lan√ßamento ou entrega neste dia.</p>';
                dayDetailsModalEl.style.display = 'flex';
                return;
            }

            // Sort entries for display (e.g., by type, then description)
            dayEntriesAllTypes.sort((a, b) => {
                 const typeOrder = { 'delivery': 0, 'receipt': 1, 'payment': 2 }; // Example order
                 if (typeOrder[a.type] !== typeOrder[b.type]) {
                    return typeOrder[a.type] - typeOrder[b.type];
                 }
                 return a.description.localeCompare(b.description);
            });


            dayEntriesAllTypes.forEach(entry => {
                 const entryElement = document.createElement('div');
                 entryElement.className = `day-entry ${entry.type}`; // Add type class
                 entryElement.dataset.entryId = entry.id; // Store ID for actions
                 entryElement.dataset.entryType = entry.type;
                 entryElement.dataset.originalId = entry.originalId || entry.id; // Store original ID if generated


                 let statusText = 'Pendente';
                 let isPastDue = false;
                 const entryDate = parseDate(entry.date);
                 const today = new Date(); today.setHours(0,0,0,0);
                 const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));


                 if (entry.type === 'receipt' || entry.type === 'payment') {
                     isPastDue = !entry.isPaid && entryDate < todayUTC;
                     if (entry.isPaid) {
                         statusText = 'Pago';
                         entryElement.classList.add('paid');
                     } else if (isPastDue) {
                         statusText = 'Atrasado';
                         entryElement.classList.add('past-due');
                     }
                 } else if (entry.type === 'delivery') {
                     isPastDue = !entry.isDelivered && entryDate < todayUTC; // Check if delivery is past due
                     if (entry.isDelivered) {
                         statusText = 'Entregue';
                         entryElement.classList.add('delivered');
                     } else if (isPastDue) {
                         statusText = 'Atrasada'; // Delivery specific status
                         entryElement.classList.add('past-due');
                     } else {
                         statusText = 'Pendente';
                     }
                 }


                 let titleIcon = '';
                 if(entry.type === 'receipt') titleIcon = '<i class="fas fa-dollar-sign"></i>';
                 else if(entry.type === 'payment') titleIcon = '<i class="fas fa-receipt"></i>';
                 else if(entry.type === 'delivery') titleIcon = '<i class="fas fa-truck"></i>';

                 let detailsHtml = `<h3>${titleIcon} ${entry.description}</h3>`;
                 if (entry.value && entry.type !== 'delivery') detailsHtml += `<p><strong>Valor:</strong> ${formatCurrency(entry.value)}</p>`;
                 if (entry.clientName) detailsHtml += `<p><strong>Cliente:</strong> ${entry.clientName}</p>`;
                 if (entry.supplier) detailsHtml += `<p><strong>Fornecedor:</strong> ${entry.supplier}</p>`;
                 if (entry.supplierContact) detailsHtml += `<p><strong>Contato:</strong> ${entry.supplierContact}</p>`;
                 if (entry.numeroPedido && entry.type === 'delivery') detailsHtml += `<p><strong>Pedido:</strong> ${entry.numeroPedido}</p>`;
                 detailsHtml += `<p><strong>Data:</strong> ${formatDate(entry.date)}</p>`;
                 detailsHtml += `<p><strong>Status:</strong> ${statusText}</p>`;
                 if (entry.type === 'payment' && entry.isRecurring && !entry.isGenerated) {
                     detailsHtml += `<p><strong>Recorr√™ncia:</strong> ${entry.recurrence === 'weekly' ? 'Semanal' : 'Mensal'}</p>`;
                 }

                 // Action Buttons
                 let actionsHtml = '<div class="entry-actions">';
                 if (entry.type === 'receipt') {
                     if (!entry.isPaid) {
                         actionsHtml += `<button class="btn-action-paid" data-action="mark-paid"><i class="fas fa-check-circle"></i> Pago</button>`;
                         actionsHtml += `<button class="btn-action-edit" data-action="edit"><i class="fas fa-edit"></i> Editar</button>`;
                         if(entry.clientPhone) actionsHtml += `<button class="btn-action-whatsapp" data-action="whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</button>`;
                     }
                     actionsHtml += `<button class="btn-action-delete" data-action="delete"><i class="fas fa-trash-alt"></i> Excluir</button>`;
                 } else if (entry.type === 'payment') {
                      // Allow actions only on original or non-generated payments
                     if (!entry.isGenerated) {
                        if (!entry.isPaid) {
                            actionsHtml += `<button class="btn-action-paid" data-action="mark-paid"><i class="fas fa-check-circle"></i> Pago</button>`;
                        }
                        actionsHtml += `<button class="btn-action-edit" data-action="edit"><i class="fas fa-edit"></i> Editar</button>`;
                        actionsHtml += `<button class="btn-action-delete" data-action="delete"><i class="fas fa-trash-alt"></i> Excluir</button>`;
                     } else {
                        // Maybe add an action to skip/delete just this generated instance?
                        actionsHtml += `<button class="btn-action-delete" data-action="delete-generated"><i class="fas fa-trash-alt"></i> Excluir Ocorr√™ncia</button>`; // Special action for generated
                     }
                 } else if (entry.type === 'delivery') {
                      if (!entry.isDelivered) {
                          // Use 'mark-delivered' action
                          actionsHtml += `<button class="btn-action-delivered" data-action="mark-delivered"><i class="fas fa-check-circle"></i> Entregue</button>`;
                      }
                     // Link to order page if orcamentoId exists
                     if (entry.orcamentoId) {
                         actionsHtml += `<a href="telaorcamento.html?orcamentoId=${entry.orcamentoId}" target="_blank" class="entry-actions button-link btn-action-edit" style="text-decoration:none; background-color:#6c757d; color:white;"><i class="fas fa-file-alt"></i> Ver Pedido</a>`;
                      }
                     // Maybe add delete action? Depends on business logic.
                 }
                 actionsHtml += '</div>';

                 entryElement.innerHTML = detailsHtml + actionsHtml;
                 dayEntriesListEl.appendChild(entryElement);
            });

            dayDetailsModalEl.style.display = 'flex';
        }

         function closeDayDetailsModal() {
            dayDetailsModalEl.style.display = 'none';
         }


        function openReportModal() {
             const year = currentDate.getFullYear();
             const month = currentDate.getMonth();
             reportTitleEl.textContent = `Relat√≥rio de ${getMonthName(month)} de ${year}`;

             let monthlyReceived = 0;
             let monthlyPaid = 0;
             const detailedEntries = [];

             allEntries.forEach(entry => {
                 const entryDate = parseDate(entry.date);
                 if (entryDate && entryDate.getUTCFullYear() === year && entryDate.getUTCMonth() === month) {
                    if (entry.type === 'receipt' && entry.isPaid) {
                         monthlyReceived += entry.value;
                         detailedEntries.push(entry);
                    } else if (entry.type === 'payment' && entry.isPaid) {
                         monthlyPaid += entry.value;
                         detailedEntries.push(entry);
                    } else if ((entry.type === 'receipt' || entry.type === 'payment') && !entry.isPaid) {
                         // Optionally include pending items in the detailed list
                         detailedEntries.push(entry);
                    }
                    // Deliveries are not included in the financial report calculation
                 }
             });

             const balance = monthlyReceived - monthlyPaid;

             reportTotalReceivedEl.textContent = formatCurrency(monthlyReceived);
             reportTotalPaidEl.textContent = formatCurrency(monthlyPaid);
             reportBalanceEl.textContent = formatCurrency(balance);
             reportBalanceEl.className = balance >= 0 ? 'value balance-positive' : 'value balance-negative';

             // Populate detailed list
             reportDetailsListEl.innerHTML = '';
             detailedEntries.sort((a, b) => (parseDate(a.date)?.getTime() || 0) - (parseDate(b.date)?.getTime() || 0)); // Sort by date

             if (detailedEntries.length > 0) {
                detailedEntries.forEach(entry => {
                    const li = document.createElement('li');
                    li.classList.add(entry.type); // Add class 'receipt' or 'payment'
                    li.innerHTML = `
                        <span>${formatDate(entry.date)} - ${entry.description} ${entry.isPaid ? '(Pago)' : '(Pendente)'}</span>
                        <span>${formatCurrency(entry.value)}</span>
                    `;
                    reportDetailsListEl.appendChild(li);
                });
             } else {
                 reportDetailsListEl.innerHTML = '<li>Nenhum lan√ßamento pago ou pendente neste m√™s.</li>';
             }

            reportModalEl.style.display = 'flex';
        }

         function closeReportModal() {
             reportModalEl.style.display = 'none';
         }

        // --- Action Functions (Interacting with Data/Firebase) ---

         async function handleFormSubmit(event) {
             event.preventDefault();
             const id = entryIdInputEl.value; // Check if we are editing
             const type = entryTypeSelectEl.value;
             const description = document.getElementById('entry-description').value.trim();
             const value = parseFloat(document.getElementById('entry-value').value);
             const date = adjustDateForFirestore(document.getElementById('entry-date').value); // Ensure YYYY-MM-DD

             // Basic validation
             if (!description || isNaN(value) || value <= 0 || !date) {
                 alert("Por favor, preencha Descri√ß√£o, Valor (> 0) e Data corretamente.");
                 return;
             }

             let dataToSave = {
                 descricao: description,
                 valor: value,
                 dataPagamento: date,
                 // isPaid is handled by mark-paid action, default to false or keep existing on edit
             };

             let collectionName = '';

             if (type === 'receipt') {
                 collectionName = 'recebimentos';
                 const clientSelect = document.getElementById('entry-client');
                 const selectedClientData = clientSelect.value ? JSON.parse(clientSelect.value) : null;
                 dataToSave.clienteId = selectedClientData?.id || null;
                 dataToSave.clienteNome = selectedClientData?.nome || null;
                 dataToSave.telefone = selectedClientData?.telefone || null;
             } else if (type === 'payment') {
                 collectionName = 'pagamentos';
                 dataToSave.fornecedor = document.getElementById('entry-supplier').value.trim() || null;
                 dataToSave.contatoFornecedor = document.getElementById('entry-supplier-contact').value.trim() || null;
                  // Only save recurrence if NOT editing a generated instance
                  const isGenerated = id && allEntries.find(e => e.id === id)?.isGenerated;
                 if (!isGenerated) {
                     dataToSave.recorrencia = document.getElementById('entry-recurrence').value;
                 }
             } else {
                 console.error("Tipo de lan√ßamento inv√°lido:", type);
                 return; // Should not happen
             }


             try {
                let action = '';
                if (id) { // Editing existing entry
                     // Prevent editing generated payment instances directly (should edit original)
                    const existingEntry = allEntries.find(e => e.id === id);
                    if (existingEntry?.isGenerated && type === 'payment') {
                         alert("N√£o √© poss√≠vel editar uma ocorr√™ncia de pagamento recorrente gerada. Edite o pagamento original para afetar futuras ocorr√™ncias.");
                         return;
                     }

                    const entryRef = doc(db, collectionName, id);
                     // Fetch existing data to preserve 'pago' status unless explicitly changed elsewhere
                    const docSnap = await getDoc(entryRef);
                    if (docSnap.exists()) {
                        dataToSave.pago = docSnap.data().pago || false; // Preserve paid status
                    } else {
                        dataToSave.pago = false; // Default if somehow editing non-existent doc
                    }
                    dataToSave.createdAt = docSnap.exists() ? (docSnap.data().createdAt || Timestamp.now()) : Timestamp.now(); // Preserve original creation time if possible

                    await updateDoc(entryRef, dataToSave);
                    action = 'atualizado';
                } else { // Adding new entry
                    dataToSave.pago = false; // New entries are not paid by default
                    dataToSave.createdAt = Timestamp.now(); // Set creation time
                    await addDoc(collection(db, collectionName), dataToSave);
                     action = 'adicionado';
                }

                 console.log(`Lan√ßamento (${type}) ${action} com sucesso.`);
                 closeEntryModal();
                 await loadEntries(); // Reload all data and update UI
                 // Optionally, provide user feedback (e.g., toast message)

             } catch (error) {
                 console.error(`Erro ao ${id ? 'atualizar' : 'adicionar'} lan√ßamento:`, error);
                 alert(`Ocorreu um erro ao salvar o lan√ßamento. Tente novamente.\n${error.message}`);
             }
         }

        async function handleEntryAction(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return; // Click wasn't on an action button

            const action = button.dataset.action;
            const entryElement = button.closest('.day-entry');
            const entryId = entryElement?.dataset.entryId;
            const entryType = entryElement?.dataset.entryType;
             const originalId = entryElement?.dataset.originalId || entryId; // Use original ID for recurring


            if (!entryId || !entryType) {
                 console.error("N√£o foi poss√≠vel obter dados do lan√ßamento para a a√ß√£o.");
                 return;
            }

            const entryData = allEntries.find(e => e.id === entryId);
             if (!entryData && action !== 'delete-generated') { // Allow delete-generated even if data isn't fully loaded yet
                 console.error("Dados completos do lan√ßamento n√£o encontrados:", entryId);
                 // Potentially try to refetch or handle gracefully
                 return;
             }


            console.log(`A√ß√£o: ${action}, ID: ${entryId}, Tipo: ${entryType}, Original ID: ${originalId}`);

             // Disable button to prevent double clicks
             button.disabled = true;
             button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Show loading indicator


            try {
                 if (action === 'edit') {
                    openEntryModal(entryData);
                 } else if (action === 'mark-paid') {
                     const collectionName = entryType === 'receipt' ? 'recebimentos' : 'pagamentos';
                     // For generated payments, marking as paid should perhaps create a record
                     // or update the original differently? For simplicity, let's mark the original if generated.
                      const idToUpdate = entryData?.isGenerated ? originalId : entryId;
                      const ref = doc(db, collectionName, idToUpdate);

                     // Security/Logic Check: If it's a generated payment, maybe we just want to record
                     // that *this instance* was paid, not modify the original 'pago' status?
                     // This requires a more complex data model (e.g., an exceptions collection).
                     // For now, updating the main doc (original or single entry)
                     await updateDoc(ref, { pago: true });
                     alert(`${entryType === 'receipt' ? 'Recebimento' : 'Pagamento'} marcado como pago!`);
                     await loadEntries(); // Reload
                     closeDayDetailsModal();

                 } else if (action === 'mark-delivered') {
                     if (entryType === 'delivery') {
                         const ref = doc(db, "pedidos", entryId);
                         await updateDoc(ref, { entregue: true, dataEntregaReal: Timestamp.now() }); // Mark delivered in 'pedidos'
                         alert('Entrega marcada como conclu√≠da!');
                         await loadEntries(); // Reload
                         closeDayDetailsModal();
                     }
                 } else if (action === 'whatsapp') {
                     if (entryData && entryData.clientPhone) {
                         const phone = entryData.clientPhone.replace(/\D/g, '');
                         const valueFormatted = formatCurrency(entryData.value);
                         const dateFormatted = formatDate(entryData.date);
                         const clientName = entryData.clientName || 'Cliente';
                         const description = entryData.description;
                         const message = encodeURIComponent(
                             `Ol√° ${clientName}! üëã\n\n` +
                             `Gostar√≠amos de lembrar sobre o recebimento pendente:\n` +
                             `Descri√ß√£o: ${description}\n` +
                             `Valor: ${valueFormatted}\n` +
                             `Vencimento: ${dateFormatted}\n\n` +
                             `Agradecemos a sua aten√ß√£o!`
                         );
                         window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
                     } else {
                         alert('Telefone do cliente n√£o dispon√≠vel.');
                     }
                 } else if (action === 'delete') {
                      // Handle deletion of original recurring payments carefully
                     const isOriginalRecurring = entryData?.isRecurring && !entryData?.isGenerated;
                      let confirmMessage = `Tem certeza que deseja excluir este ${entryType === 'receipt' ? 'recebimento' : 'pagamento'}?`;
                      if (isOriginalRecurring) {
                          confirmMessage += '\n\nAten√ß√£o: Isto √© um lan√ßamento recorrente original. Excluir ir√° remover TODAS as futuras ocorr√™ncias geradas.';
                      }

                     if (confirm(confirmMessage)) {
                         const collectionName = entryType === 'receipt' ? 'recebimentos' : 'pagamentos';
                         await deleteDoc(doc(db, collectionName, entryId));

                         // If deleting an original recurring payment, we might need to delete its generated instances
                         // This requires querying for generated instances based on originalId, which is complex here.
                         // Simpler approach: Reloading entries will naturally remove the source and its generated children won't appear.

                         alert(`${entryType === 'receipt' ? 'Recebimento' : 'Pagamento'} exclu√≠do com sucesso!`);
                         await loadEntries();
                         closeDayDetailsModal();
                     }
                  } else if (action === 'delete-generated') {
                      // This action is specific to generated payment instances
                      // It doesn't delete anything from Firestore, just removes this instance from the view
                      if (confirm("Tem certeza que deseja remover esta ocorr√™ncia gerada do calend√°rio? O pagamento recorrente original n√£o ser√° afetado.")) {
                         // Find and remove the specific generated instance from the `allEntries` array
                         allEntries = allEntries.filter(e => e.id !== entryId);
                         alert("Ocorr√™ncia removida do calend√°rio.");
                         updateCalendar(); // Re-render the calendar without the deleted instance
                         closeDayDetailsModal();
                     }
                  }

             } catch (error) {
                console.error(`Erro ao executar a√ß√£o "${action}":`, error);
                alert(`Ocorreu um erro: ${error.message}`);
             } finally {
                 // Re-enable button if it wasn't an edit action that closes the modal anyway
                 if (action !== 'edit' && button.parentNode) { // Check if button still exists
                    // Restore original button text/icon (more complex logic needed for specific icons)
                     button.innerHTML = button.innerHTML.replace('<i class="fas fa-spinner fa-spin"></i>', '<i class="fas fa-check"></i>'); // Placeholder restore
                    button.disabled = false;
                 }
             }
        }


        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            loadClients(); // Load clients for the dropdown
            loadEntries(); // Load all entries initially

            // Calendar Navigation
            prevMonthBtnEl.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                loadEntries(); // Reload entries for the new month view
            });
            nextMonthBtnEl.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                loadEntries(); // Reload entries
            });

            // Filter Buttons
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentFilter = button.dataset.filter;
                    updateCalendar(); // Re-render calendar with the new filter
                });
            });

            // Open Add/Edit Modal
            openModalBtnEl.addEventListener('click', () => openEntryModal());

            // Open Report Modal
            openReportModalBtnEl.addEventListener('click', openReportModal);


            // Close Modals (using data attribute for multiple close buttons)
            document.querySelectorAll('[data-close-modal]').forEach(button => {
                 button.addEventListener('click', () => {
                    button.closest('.modal').style.display = 'none';
                     // Reset form only if closing the entry modal via cancel/close
                     if (button.closest('.modal')?.id === 'entry-modal') {
                         entryFormEl.reset();
                         entryFormEl.removeAttribute('data-editar-id');
                         document.getElementById('entry-client').value = '';
                         document.getElementById('entry-recurrence').value = 'none';
                         document.querySelector('#entry-modal h2').textContent = 'Novo Lan√ßamento';
                         toggleEntryFields(); // Reset fields visibility
                     }
                });
            });

            // Toggle fields based on entry type selection
             entryTypeSelectEl.addEventListener('change', toggleEntryFields);

            // Handle Form Submission (Add/Edit)
             entryFormEl.addEventListener('submit', handleFormSubmit);

            // Handle Actions within Day Details Modal (Event Delegation)
             dayEntriesListEl.addEventListener('click', handleEntryAction);

        }); // End DOMContentLoaded

    </script>

</body>
</html>