<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Pedidos v4 - Responsivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- Estilos (Base anterior + Ajustes Modal Parcelamento Manual) --- */
        :root { /* ... Variáveis de cor ... */
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
            --light-color: #f8f9fa; --dark-color: #343a40; --border-color: #dee2e6;
            --background-color: #eef1f5; --card-background: #ffffff; --text-color: #495057;
            --text-muted: #6c757d; --shadow-sm: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            --shadow-md: 0 0.5rem 1rem rgba(0,0,0,0.1); --border-radius: 0.375rem;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; font-size: 16px; padding: 20px; }
        .container { background-color: var(--card-background); padding: 25px 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); max-width: 1400px; margin: 20px auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .page-header h1 { font-size: 1.8rem; font-weight: 500; color: var(--dark-color); margin: 0; }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; background-color: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-bottom: 25px; }
        .filter-controls > div { flex: 1 1 200px; min-width: 180px; }
        .filter-controls label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-muted); font-size: 0.85rem; }
        .filter-controls select, .filter-controls input[type="text"] { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; height: 38px; }
        .filter-controls button { padding: 8px 15px; font-size: 0.9rem; height: 38px; flex-shrink: 0; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 0.95rem; }
        th, td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; vertical-align: middle; }
        th { background-color: var(--light-color); font-weight: 500; color: var(--text-muted); white-space: nowrap; font-size: 0.85rem; }
        tbody tr:nth-child(even) { background-color: #fdfdfe; }
        tbody tr:hover { background-color: #f1f1f1; }
        .col-actions { text-align: center; white-space: nowrap; }
        .col-valor { text-align: right; white-space: nowrap; }
        .col-status { text-align: center; white-space: nowrap; font-weight: 500; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid transparent; }
        .status-entregue { background-color: var(--success-color); color: white; border-color: #1e7e34;}
        .status-atrasado { background-color: var(--danger-color); color: white; border-color: #bd2130;}
        .status-proximo { background-color: var(--warning-color); color: var(--dark-color); border-color: #d39e00;}
        .status-pendente { background-color: var(--light-color); color: var(--text-muted); border-color: var(--border-color); }
        .status-pago { background-color: var(--info-color); color: white; border-color: #0c7a8a;}
        .status-parcelado { background-color: #6f42c1; color:white; border-color: #5a349a;}

        /* --- Botões --- */
        button, .button-link { display: inline-block; padding: 8px 15px; font-size: 0.9rem; font-weight: 500; text-align: center; white-space: nowrap; vertical-align: middle; user-select: none; border: 1px solid transparent; border-radius: var(--border-radius); transition: all 0.15s ease-in-out; cursor: pointer; text-decoration: none; }
        button i, .button-link i { margin-right: 5px; }
        button:disabled { opacity: 0.65; cursor: not-allowed; }
        .btn-primary { color: #fff; background-color: var(--primary-color); border-color: var(--primary-color); } .btn-primary:hover { background-color: #0056b3; border-color: #004085; }
        .btn-secondary { color: #fff; background-color: var(--secondary-color); border-color: var(--secondary-color); } .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
        .btn-success { color: #fff; background-color: var(--success-color); border-color: var(--success-color); } .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .btn-danger { color: #fff; background-color: var(--danger-color); border-color: var(--danger-color); } .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .btn-info { color: #fff; background-color: var(--info-color); border-color: var(--info-color); } .btn-info:hover { background-color: #138496; border-color: #117a8b; }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; margin: 0 2px; }

        /* --- Modal (Geral) --- */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #ddd; width: 90%; max-width: 650px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 1.4em; }
        .close-modal-btn { color: #aaa; background: none; border: none; font-size: 28px; font-weight: bold; cursor: pointer; padding: 0 5px; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: black; }
        .modal-body label { display: block; margin: 10px 0 5px 0; font-weight: 500; }
        .modal-body input[type="date"], .modal-body input[type="number"], .modal-body select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; margin-bottom: 10px; box-sizing: border-box;}
        .modal-footer { text-align: right; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .modal-footer button { margin-left: 10px; }

        /* --- Estilos Específicos Modal Pagamento --- */
        .payment-type-selector { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .payment-type-selector label { margin-right: 15px; font-weight: normal; display: inline-block; }
        .payment-method-selector { margin-top: 15px; margin-bottom: 15px; }
        .payment-method-selector label { margin-right: 15px; font-weight: normal; display: inline-block; }
        .payment-details { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .parcelas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .manual-dates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; max-height: 250px; overflow-y: auto; padding-top: 10px;}
        .manual-date-item label { font-size: 0.85em; margin-bottom: 2px; color: var(--text-muted); }
        .hidden { display: none; }

        /* Loading/Empty Messages */
        #loading-message, #empty-message { text-align: center; padding: 20px; color: var(--text-muted); font-size: 1.1rem; }

        /* --- Responsividade --- */

        /* Telas Médias (Tablets e Smartphones Grandes - < 992px) */
        @media (max-width: 991.98px) {
            .filter-controls {
                /* grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Permitir mais flexibilidade - REMOVIDO, usando flex-wrap padrão */
                gap: 10px; /* Reduzir gap */
            }
            .container {
                padding: 20px; /* Reduzir padding container */
            }
             th, td {
                padding: 8px 10px; /* Reduzir padding células */
             }
        }

        /* Telas Pequenas (Smartphones - < 768px) */
        @media (max-width: 767.98px) {
            body {
                padding: 10px; /* Menos padding no body */
                font-size: 15px; /* Leve redução fonte base */
            }
            .container {
                padding: 15px; /* Menos padding */
            }
            .page-header {
                flex-direction: column; /* Empilhar título e talvez botões (se houver) */
                align-items: flex-start; /* Alinhar à esquerda */
                margin-bottom: 20px;
            }
            .page-header h1 {
                font-size: 1.5rem; /* Reduzir título */
                margin-bottom: 10px; /* Espaço se empilhado */
            }

            /* Filtros empilhados */
            .filter-controls {
                display: flex; /* Mudar pra flex para empilhar */
                flex-direction: column;
                gap: 12px; /* Espaçamento entre filtros empilhados */
                 padding: 12px;
            }
            .filter-controls > div {
                flex: 1 1 auto; /* Ocupar largura disponível */
                min-width: 0; /* Resetar min-width */
                 width: 100%; /* Garantir largura total */
            }
            .filter-controls button {
                width: 100%; /* Botão ocupa largura toda */
                margin-top: 5px; /* Espaço acima do botão */
            }

            /* Tabela: Manter scroll horizontal mas garantir boa leitura */
            th, td {
                padding: 8px; /* Menos padding ainda */
                font-size: 0.9rem; /* Reduzir fonte da tabela */
                white-space: nowrap; /* Evitar quebra de linha em células importantes */
            }
             /* Opcional: Ocultar colunas menos importantes */
             /*
             th:nth-child(3), td:nth-child(3) { display: none; } // Ex: Esconder Data Pedido
             */

             /* Ajuste nos botões de ação */
             .col-actions button, .col-actions .button-link {
                 padding: 5px 8px; /* Botões menores */
                 font-size: 0.8rem;
                 margin-bottom: 3px; /* Espaço se quebrar linha */
                 display: inline-block; /* Garantir que fiquem na linha se couber */
             }

            /* Modal */
            .modal-content {
                width: 95%; /* Usar quase toda a largura */
                margin: 15px auto; /* Reduzir margem */
                padding: 20px; /* Menos padding */
                max-height: 90vh; /* Limitar altura e habilitar scroll interno se necessário */
                overflow-y: auto; /* Scroll se conteúdo for maior */
            }
            .modal-header h2 {
                font-size: 1.25rem; /* Título menor */
            }
            .modal-body {
                font-size: 0.95rem; /* Fonte do corpo do modal */
            }
             .modal-footer {
                 display: flex;
                 flex-direction: column; /* Empilhar botões do footer */
                 gap: 10px;
                 align-items: stretch; /* Esticar botões */
             }
             .modal-footer button {
                 width: 100%;
                 margin-left: 0; /* Remover margem esquerda */
             }

            /* Ajustar grids internos do modal */
            .parcelas-grid, .manual-dates-grid {
                 grid-template-columns: 1fr; /* Uma coluna apenas */
                 gap: 12px;
             }
             .manual-dates-grid {
                 max-height: 200px; /* Reduzir altura scroll */
             }
        }

        /* Telas Muito Pequenas (< 480px) */
        @media (max-width: 479.98px) {
            body {
                font-size: 14px; /* Reduzir ainda mais fonte base */
            }
            .page-header h1 {
                font-size: 1.3rem;
            }
             th, td {
                font-size: 0.85rem; /* Fonte da tabela ainda menor */
                 padding: 6px;
            }
             .status-badge {
                 padding: 3px 6px;
                 font-size: 0.7rem;
             }
            .col-actions button, .col-actions .button-link {
                 font-size: 0.75rem;
                 padding: 4px 6px;
            }
             .modal-content {
                 padding: 15px;
             }
             .modal-header h2 {
                 font-size: 1.1rem;
             }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>Gestão de Pedidos</h1>
        </div>

        <div class="filter-controls">
            <div> <label for="filtro-cliente">Cliente</label> <select id="filtro-cliente"><option value="">Todos</option></select> </div>
            <div> <label for="filtro-status-entrega">Status Entrega</label> <select id="filtro-status-entrega"><option value="">Todos</option><option value="pendente">Pendente</option><option value="proximo">Próximo</option><option value="atrasado">Atrasado</option><option value="entregue">Entregue</option></select> </div>
            <div> <label for="filtro-status-pagamento">Status Pagamento</label> <select id="filtro-status-pagamento"><option value="">Todos</option><option value="pendente">Pendente</option><option value="pago">Pago</option><option value="parcelado">Parcelado</option></select> </div>
            <div> <label for="busca-numero-pedido">Buscar Nº Pedido</label> <input type="text" id="busca-numero-pedido" placeholder="Número..."> </div>
            <button id="btn-limpar-filtros" class="btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
        </div>

        <div class="table-container">
            <table id="tabela-pedidos">
                <thead>
                    <tr>
                        <th>Nº Pedido</th> <th>Cliente</th> <th>Data Pedido</th>
                        <th class="col-valor">Valor Total</th> <th class="col-status">Status Entrega</th> <th class="col-status">Status Pagamento</th>
                        <th class="col-actions">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela-pedidos-body"></tbody>
            </table>
            <div id="loading-message" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Carregando... </div>
            <div id="empty-message" style="display: none;"> Nenhum pedido encontrado. </div>
        </div>
    </div>

    <div id="payment-config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="payment-modal-title">Configurar Pagamento/Entrega - Pedido #<span id="modal-pedido-numero"></span></h2>
                <button id="close-payment-modal-btn" class="close-modal-btn">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-pedido-id">
                <input type="hidden" id="modal-pedido-total">
                <input type="hidden" id="modal-cliente-info"> <div>
                    <label for="modal-data-entrega">Data Oficial de Entrega:</label>
                    <input type="date" id="modal-data-entrega">
                </div>
                <hr style="margin: 20px 0;">

                <div class="payment-type-selector">
                    <strong>Tipo de Pagamento:</strong>
                    <label><input type="radio" name="tipoPagamento" value="unico" checked> Único</label>
                    <label><input type="radio" name="tipoPagamento" value="parcelado"> Parcelado</label>
                </div>

                <div id="detalhes-pagamento-unico" class="payment-details">
                    <label for="modal-data-pagamento-unico">Data Pagamento Único:</label>
                    <input type="date" id="modal-data-pagamento-unico">
                </div>

                <div id="detalhes-pagamento-parcelado" class="payment-details hidden">
                    <div class="parcelas-grid">
                        <div>
                            <label for="modal-num-parcelas">Nº de Parcelas:</label>
                            <input type="number" id="modal-num-parcelas" min="1" value="2"> </div>
                        <div>
                            <label for="modal-valor-parcela">Valor Parcela (R$):</label>
                            <input type="number" id="modal-valor-parcela" step="0.01" placeholder="Automático se vazio">
                        </div>
                    </div>
                    <small style="color: var(--text-muted); display: block; margin: 5px 0 15px 0;">Deixe o valor vazio para calcular automaticamente.</small>

                    <div class="payment-method-selector">
                        <strong>Definir Datas das Parcelas:</strong>
                        <label><input type="radio" name="metodoParcela" value="intervalo" checked> Calcular com Intervalo</label>
                        <label><input type="radio" name="metodoParcela" value="manual"> Digitar Manualmente</label>
                    </div>

                    <div id="interval-inputs">
                        <div class="parcelas-grid">
                            <div>
                                <label for="modal-data-primeira-parcela">Data 1ª Parcela:</label>
                                <input type="date" id="modal-data-primeira-parcela">
                            </div>
                            <div>
                                <label for="modal-intervalo-parcelas">Intervalo (dias):</label>
                                <input type="number" id="modal-intervalo-parcelas" value="30" min="1">
                            </div>
                        </div>
                    </div>

                    <div id="manual-dates-container" class="hidden">
                        <label>Datas das Parcelas:</label>
                        <div id="manual-dates-grid" class="manual-dates-grid">
                            </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-remover-config-pagamento" class="btn-danger"><i class="fas fa-times-circle"></i> Remover Config. Pagamento</button>
                <button id="btn-salvar-config-pagamento" class="btn-success"><i class="fas fa-save"></i> Salvar Configuração</button>
                <button id="btn-cancelar-payment-modal" type="button" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Imports Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, orderBy, where, getDoc, deleteField, Timestamp, writeBatch, addDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // --- Configuração Firebase ---
        const firebaseConfig = { // --- COLOQUE SUA CONFIGURAÇÃO REAL AQUI ---
              apiKey: "AIzaSyCVkb1-tdd5SL8jA2Cw2B0aeugu8SaCUBc",
              authDomain: "testebosspro.firebaseapp.com",
              projectId: "testebosspro",
              storageBucket: "testebosspro.appspot.com",
              messagingSenderId: "73684788134",
              appId: "1:73684788134:web:7c8250c83f10a2df59e567",
              measurementId: "G-1H29L5B830"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Elementos DOM ---
        const filtroClienteSelect = document.getElementById('filtro-cliente');
        const filtroStatusEntregaSelect = document.getElementById('filtro-status-entrega');
        const filtroStatusPagamentoSelect = document.getElementById('filtro-status-pagamento');
        const buscaNumeroPedidoInput = document.getElementById('busca-numero-pedido');
        const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
        const tabelaBody = document.getElementById('tabela-pedidos-body');
        const loadingMessage = document.getElementById('loading-message');
        const emptyMessage = document.getElementById('empty-message');
        const paymentConfigModal = document.getElementById('payment-config-modal');
        const closePaymentModalBtn = document.getElementById('close-payment-modal-btn');
        const cancelPaymentModalBtn = document.getElementById('btn-cancelar-payment-modal');
        const modalPedidoNumeroSpan = document.getElementById('modal-pedido-numero');
        const modalPedidoIdInput = document.getElementById('modal-pedido-id');
        const modalPedidoTotalInput = document.getElementById('modal-pedido-total');
        const modalClienteInfoInput = document.getElementById('modal-cliente-info');
        const modalDataEntregaInput = document.getElementById('modal-data-entrega');
        const paymentTypeRadios = document.querySelectorAll('input[name="tipoPagamento"]');
        const detalhesUnicoDiv = document.getElementById('detalhes-pagamento-unico');
        const detalhesParceladoDiv = document.getElementById('detalhes-pagamento-parcelado');
        const modalDataPagamentoUnicoInput = document.getElementById('modal-data-pagamento-unico');
        const modalNumParcelasInput = document.getElementById('modal-num-parcelas');
        const modalValorParcelaInput = document.getElementById('modal-valor-parcela');
        const installmentMethodRadios = document.querySelectorAll('input[name="metodoParcela"]');
        const intervalInputsDiv = document.getElementById('interval-inputs');
        const modalDataPrimeiraParcelaInput = document.getElementById('modal-data-primeira-parcela');
        const modalIntervaloParcelasInput = document.getElementById('modal-intervalo-parcelas');
        const manualDatesContainer = document.getElementById('manual-dates-container');
        const manualDatesGrid = document.getElementById('manual-dates-grid');
        const btnSalvarConfigPagamento = document.getElementById('btn-salvar-config-pagamento');
        const btnRemoverConfigPagamento = document.getElementById('btn-remover-config-pagamento');

        // --- Variáveis Globais ---
        let todosPedidosArray = [];
        let clientesMap = new Map(); // Para usar no filtro e na renderização

        // --- Funções Utilitárias ---
        function formatarValorBRL(valor) { return `R$ ${(parseFloat(valor) || 0).toFixed(2).replace('.', ',')}`; }
        function formatarDataExibicao(dataObj) { if (!dataObj || !(dataObj instanceof Date) || isNaN(dataObj)) return 'N/A'; try { return dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch { return 'Inválida'; } }
        function dataStringToDate(dataString) { if (!dataString) return null; try { const [y, m, d] = dataString.split('-'); if (y && m && d) return new Date(Date.UTC(parseInt(y), parseInt(m) - 1, parseInt(d))); /* Use UTC */ } catch {} return null; }
        function dateToYYYYMMDD(dateObj) { if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj)) return ''; try { const year = dateObj.getUTCFullYear(); const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0'); const day = String(dateObj.getUTCDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } catch { return ''; } }
        function addDays(date, days) { const result = new Date(date); result.setUTCDate(result.getUTCDate() + days); return result; }

        // --- Funções Principais ---

        async function carregarClientesFiltro() {
              clientesMap = new Map();
              filtroClienteSelect.innerHTML = '<option value="">Todos</option>'; // Reseta
              try {
                  const q = query(collection(db, "clientes"), orderBy("empresa")); // Ordena por nome/empresa
                  const querySnapshot = await getDocs(q);
                  querySnapshot.forEach((doc) => {
                      const cliente = doc.data();
                      const id = doc.id;
                      const nomeExibicao = `${cliente.empresa || cliente.nome || 'Cliente Sem Nome'} (${cliente.codigo || 'S/C'})`;
                      clientesMap.set(id, { nome: nomeExibicao, telefone: cliente.telefone }); // Armazena nome e telefone
                      const option = document.createElement("option");
                      option.value = id;
                      option.textContent = nomeExibicao;
                      filtroClienteSelect.appendChild(option);
                  });
                  console.log(`${clientesMap.size} Clientes carregados para o filtro.`);
              } catch (error) {
                  console.error("Erro ao carregar clientes para filtro:", error);
              }
          }

        async function carregarPedidos() {
            loadingMessage.style.display = 'block';
            emptyMessage.style.display = 'none';
            tabelaBody.innerHTML = '';
            todosPedidosArray = []; // Limpa array de pedidos
            try {
                const q = query(collection(db, "pedidos"), orderBy("numeroPedido", "desc")); // Ordena por número desc.
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    // Adiciona o nome e telefone do cliente diretamente ao objeto pedido se encontrado no map
                    const pedidoData = doc.data();
                    const clienteInfo = clientesMap.get(pedidoData.clienteId);
                    todosPedidosArray.push({
                        id: doc.id,
                        ...pedidoData,
                        clienteNome: clienteInfo?.nome || pedidoData.clienteNome || 'Cliente Desconhecido', // Usa nome do map se disponível
                        clienteTelefone: clienteInfo?.telefone || pedidoData.clienteTelefone || null // Usa telefone do map se disponível
                    });
                });
                console.log(`Total de ${todosPedidosArray.length} pedidos carregados.`);
                aplicarFiltros(); // Aplica filtros e renderiza a tabela
            } catch (error) {
                console.error("Erro ao carregar pedidos:", error);
                emptyMessage.textContent = "Erro ao carregar os pedidos.";
                emptyMessage.style.display = 'block';
            } finally {
                loadingMessage.style.display = 'none'; // Esconde mensagem de carregamento
            }
        }

        function calcularStatusEntrega(pedido) {
              if (pedido.entregue) return { texto: 'Entregue', classe: 'status-entregue' };
              if (pedido.dataEntregaOficial) {
                  const hoje = new Date(); hoje.setUTCHours(0, 0, 0, 0); // Data de hoje em UTC
                  const dataEntrega = dataStringToDate(pedido.dataEntregaOficial);
                  if (!dataEntrega) return { texto: 'Pendente (Data Inv.)', classe: 'status-pendente' }; // Data inválida

                  if (dataEntrega < hoje) return { texto: 'Atrasado', classe: 'status-atrasado' };

                  const diffTime = dataEntrega.getTime() - hoje.getTime();
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                  if (diffDays <= 7) return { texto: 'Próximo', classe: 'status-proximo' };
                  return { texto: `Pendente (${formatarDataExibicao(dataEntrega)})`, classe: 'status-pendente' };
              }
              return { texto: 'Pendente', classe: 'status-pendente' }; // Sem data definida
          }

        function calcularStatusPagamento(pedido) {
            if (pedido.dataPagamentoOficial) return { texto: 'Pago (Único)', classe: 'status-pago' };
            if (pedido.parcelamentoInfo && pedido.parcelamentoInfo.numero > 0) return { texto: 'Parcelado', classe: 'status-parcelado' };
            return { texto: 'Pendente', classe: 'status-pendente' };
        }

        function aplicarFiltros() {
            const clienteIdFiltro = filtroClienteSelect.value;
            const statusEntregaFiltro = filtroStatusEntregaSelect.value;
            const statusPagamentoFiltro = filtroStatusPagamentoSelect.value;
            const numeroPedidoBusca = buscaNumeroPedidoInput.value.trim().toLowerCase();

            const pedidosFiltrados = todosPedidosArray.filter(pedido => {
                // Filtro Cliente
                const matchCliente = !clienteIdFiltro || pedido.clienteId === clienteIdFiltro;

                // Filtro Número Pedido
                const matchNumero = !numeroPedidoBusca || (pedido.numeroPedido && pedido.numeroPedido.toLowerCase().includes(numeroPedidoBusca));

                // Filtro Status Entrega
                const statusEntregaInfo = calcularStatusEntrega(pedido);
                let matchStatusEntrega = true;
                if (statusEntregaFiltro) {
                    if (statusEntregaFiltro === 'pendente' && statusEntregaInfo.classe.includes('pendente')) matchStatusEntrega = true; // Inclui pendente com data
                    else if (statusEntregaFiltro === 'proximo' && statusEntregaInfo.classe === 'status-proximo') matchStatusEntrega = true;
                    else if (statusEntregaFiltro === 'atrasado' && statusEntregaInfo.classe === 'status-atrasado') matchStatusEntrega = true;
                    else if (statusEntregaFiltro === 'entregue' && statusEntregaInfo.classe === 'status-entregue') matchStatusEntrega = true;
                    else matchStatusEntrega = false;
                }

                // Filtro Status Pagamento
                const statusPagamentoInfo = calcularStatusPagamento(pedido);
                let matchStatusPagamento = true;
                if (statusPagamentoFiltro) {
                    if (statusPagamentoFiltro === 'pendente' && statusPagamentoInfo.classe === 'status-pendente') matchStatusPagamento = true;
                    else if (statusPagamentoFiltro === 'pago' && statusPagamentoInfo.classe === 'status-pago') matchStatusPagamento = true;
                    else if (statusPagamentoFiltro === 'parcelado' && statusPagamentoInfo.classe === 'status-parcelado') matchStatusPagamento = true;
                    else matchStatusPagamento = false;
                }

                return matchCliente && matchNumero && matchStatusEntrega && matchStatusPagamento;
            });
            renderizarTabelaPedidos(pedidosFiltrados);
        }

        function renderizarTabelaPedidos(pedidosParaRenderizar) {
              tabelaBody.innerHTML = ''; // Limpa tabela
              if (pedidosParaRenderizar.length === 0) {
                  emptyMessage.style.display = 'block';
                  emptyMessage.textContent = "Nenhum pedido encontrado com os filtros selecionados.";
              } else {
                  emptyMessage.style.display = 'none';
                  pedidosParaRenderizar.forEach(pedido => {
                      const tr = document.createElement('tr');
                      tr.dataset.pedidoId = pedido.id; // Armazena ID na linha

                      // Usa nome do cliente do objeto pedido (que já foi enriquecido)
                      const clienteNome = pedido.clienteNome || 'Cliente Desconhecido';
                      const dataPedido = pedido.dataCriacao ? dataStringToDate(pedido.dataCriacao.substring(0, 10)) : null; // Assume dataCriacao como string yyyy-MM-dd
                      const statusEntregaInfo = calcularStatusEntrega(pedido);
                      const statusPagamentoInfo = calcularStatusPagamento(pedido);

                      tr.innerHTML = `
                          <td>${pedido.numeroPedido || pedido.id.substring(0, 6).toUpperCase()}</td>
                          <td>${clienteNome}</td>
                          <td>${formatarDataExibicao(dataPedido)}</td>
                          <td class="col-valor">${formatarValorBRL(pedido.totalGeral)}</td>
                          <td class="col-status"><span class="status-badge ${statusEntregaInfo.classe}">${statusEntregaInfo.texto}</span></td>
                          <td class="col-status"><span class="status-badge ${statusPagamentoInfo.classe}">${statusPagamentoInfo.texto}</span></td>
                          <td class="col-actions">
                              <button class="btn-info btn-sm btn-gerenciar-pagamento" title="Configurar Pagamento/Entrega"><i class="fas fa-calendar-alt"></i> Pgt/Entr</button>
                              ${!pedido.entregue ? `<button class="btn-success btn-sm btn-marcar-entregue" title="Marcar Entregue"><i class="fas fa-check-circle"></i> Entregue</button>` : ''}
                              ${pedido.orcamentoId ? `<a href="telaorcamento.html?orcamentoId=${pedido.orcamentoId}" target="_blank" class="button-link btn-secondary btn-sm" title="Ver Orçamento"><i class="fas fa-file-alt"></i> Orçam.</a>` : ''}
                          </td>
                      `;
                      tabelaBody.appendChild(tr);
                  });
                  addListenersBotoesAcao(); // Adiciona listeners aos botões da tabela
              }
          }

        function addListenersBotoesAcao() {
            // Botão Gerenciar Pagamento/Entrega
            document.querySelectorAll('.btn-gerenciar-pagamento').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const pedidoId = e.currentTarget.closest('tr').dataset.pedidoId;
                    abrirModalConfiguracaoPagamento(pedidoId); // Chama a função para abrir o modal
                });
            });

            // Botão Marcar Entregue
            document.querySelectorAll('.btn-marcar-entregue').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const tr = e.currentTarget.closest('tr');
                    const pedidoId = tr.dataset.pedidoId;
                    const pedidoNum = tr.cells[0].textContent; // Pega número da primeira célula
                    if (!confirm(`Tem certeza que deseja marcar o Pedido #${pedidoNum} como ENTREGUE?`)) return;

                    // Feedback visual e desabilita botão
                    e.currentTarget.disabled = true;
                    e.currentTarget.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    try {
                        const pedidoRef = doc(db, "pedidos", pedidoId);
                        await updateDoc(pedidoRef, {
                            entregue: true,
                            dataEntregaReal: Timestamp.fromDate(new Date()) // Grava data real da entrega
                        });
                        // Atualiza a linha na tabela localmente para feedback imediato
                        const pedidoIndex = todosPedidosArray.findIndex(p => p.id === pedidoId);
                         if(pedidoIndex > -1) {
                             todosPedidosArray[pedidoIndex].entregue = true;
                             todosPedidosArray[pedidoIndex].dataEntregaReal = new Date(); // Atualiza localmente
                         }
                         aplicarFiltros(); // Re-renderiza a tabela com status atualizado
                        alert(`Pedido #${pedidoNum} marcado como entregue com sucesso!`);
                    } catch (err) {
                        console.error("Erro ao marcar como entregue:", err);
                        alert("Ocorreu um erro ao tentar marcar o pedido como entregue.");
                        e.currentTarget.disabled = false; // Reabilita botão em caso de erro
                        e.currentTarget.innerHTML = '<i class="fas fa-check-circle"></i> Entregue';
                    }
                });
            });
        }

        // --- Funções do Modal de Configuração de Pagamento ---

        async function abrirModalConfiguracaoPagamento(pedidoId) {
              const pedido = todosPedidosArray.find(p => p.id === pedidoId);
              if (!pedido) { alert("Erro: Pedido não encontrado localmente."); return; }

              modalPedidoIdInput.value = pedidoId;
              modalPedidoNumeroSpan.textContent = pedido.numeroPedido || pedidoId.substring(0,6).toUpperCase();
              modalPedidoTotalInput.value = pedido.totalGeral || 0;
              modalDataEntregaInput.value = pedido.dataEntregaOficial || '';

              // --- Busca cliente para garantir dados atualizados (igual anterior) ---
              let clienteNomeAtualizado = pedido.clienteNome || 'Cliente Desconhecido';
              let clienteTelefoneAtualizado = pedido.clienteTelefone || null;
              if (pedido.clienteId) {
                  try {
                      const clienteRef = doc(db, "clientes", pedido.clienteId);
                      const clienteSnap = await getDoc(clienteRef);
                      if (clienteSnap.exists()) {
                          const clienteData = clienteSnap.data();
                          clienteNomeAtualizado = `${clienteData.empresa || clienteData.nome || 'Cliente Sem Nome'} (${clienteData.codigo || 'S/C'})`;
                          clienteTelefoneAtualizado = clienteData.telefone || null;
                      } else { console.warn(`Cliente ${pedido.clienteId} não encontrado.`); }
                  } catch (error) { console.error(`Erro ao buscar cliente ${pedido.clienteId}:`, error); }
              }
              modalClienteInfoInput.value = JSON.stringify({ id: pedido.clienteId || null, nome: clienteNomeAtualizado, telefone: clienteTelefoneAtualizado });
               // --- Fim Busca Cliente ---


              // Reseta estado inicial do modal de pagamento
              manualDatesGrid.innerHTML = '';
              intervalInputsDiv.classList.add('hidden'); // Começa escondido
              manualDatesContainer.classList.add('hidden');
              detalhesUnicoDiv.classList.add('hidden'); // Começa escondido
              detalhesParceladoDiv.classList.add('hidden'); // Começa escondido
              btnRemoverConfigPagamento.style.display = 'none';

              // Verifica configuração existente e preenche
              if (pedido.parcelamentoInfo && pedido.parcelamentoInfo.numero > 0) { // Configuração de Parcelamento existe
                  document.querySelector('input[name="tipoPagamento"][value="parcelado"]').checked = true;
                  detalhesParceladoDiv.classList.remove('hidden');
                  btnRemoverConfigPagamento.style.display = 'inline-block';

                  modalNumParcelasInput.value = pedido.parcelamentoInfo.numero || 2;
                  modalValorParcelaInput.value = pedido.parcelamentoInfo.valor ? pedido.parcelamentoInfo.valor.toFixed(2) : '';

                  if (pedido.parcelamentoInfo.modo === 'manual' && Array.isArray(pedido.parcelamentoInfo.datas)) {
                      document.querySelector('input[name="metodoParcela"][value="manual"]').checked = true;
                      manualDatesContainer.classList.remove('hidden');
                      gerarCamposDataManual(pedido.parcelamentoInfo.numero, pedido.parcelamentoInfo.datas);
                  } else { // Intervalo (ou default)
                      document.querySelector('input[name="metodoParcela"][value="intervalo"]').checked = true;
                      intervalInputsDiv.classList.remove('hidden');
                      modalDataPrimeiraParcelaInput.value = pedido.parcelamentoInfo.dataInicio || '';
                      modalIntervaloParcelasInput.value = pedido.parcelamentoInfo.intervalo || 30;
                  }
              } else if (pedido.dataPagamentoOficial) { // Configuração de Pagamento Único existe
                  document.querySelector('input[name="tipoPagamento"][value="unico"]').checked = true;
                  detalhesUnicoDiv.classList.remove('hidden');
                  modalDataPagamentoUnicoInput.value = pedido.dataPagamentoOficial;
                  btnRemoverConfigPagamento.style.display = 'inline-block';
              } else { // Nenhuma configuração encontrada, default para Pagamento Único
                  document.querySelector('input[name="tipoPagamento"][value="unico"]').checked = true;
                  detalhesUnicoDiv.classList.remove('hidden');
                  modalDataPagamentoUnicoInput.value = '';
              }

              paymentConfigModal.style.display = 'block'; // Mostra o modal
          }

        function fecharModalConfiguracaoPagamento() {
            paymentConfigModal.style.display = 'none';
        }

        function gerarCamposDataManual(numParcelas, datasPreenchidas = []) {
            manualDatesGrid.innerHTML = ''; // Limpa
            if (isNaN(numParcelas) || numParcelas < 1) return;

            for (let i = 0; i < numParcelas; i++) {
                const div = document.createElement('div');
                div.classList.add('manual-date-item');
                const label = document.createElement('label');
                label.textContent = `Data Parcela ${i + 1}:`;
                label.htmlFor = `manual-date-${i}`;
                const input = document.createElement('input');
                input.type = 'date';
                input.id = `manual-date-${i}`;
                input.dataset.parcelaIndex = i;
                input.required = true;
                if (datasPreenchidas && datasPreenchidas[i]) {
                    input.value = datasPreenchidas[i];
                }
                div.appendChild(label);
                div.appendChild(input);
                manualDatesGrid.appendChild(div);
            }
        }

        // --- Lógica de Alternância no Modal ---
        paymentTypeRadios.forEach(radio => {
             radio.addEventListener('change', (e) => {
                 const isUnico = e.target.value === 'unico';
                 detalhesUnicoDiv.classList.toggle('hidden', !isUnico);
                 detalhesParceladoDiv.classList.toggle('hidden', isUnico);
                 if (!isUnico) { // Se mudou para parcelado, mostra a opção de método default
                     const metodoSelecionado = document.querySelector('input[name="metodoParcela"]:checked').value;
                     intervalInputsDiv.classList.toggle('hidden', metodoSelecionado !== 'intervalo');
                     manualDatesContainer.classList.toggle('hidden', metodoSelecionado !== 'manual');
                      if(metodoSelecionado === 'manual') gerarCamposDataManual(parseInt(modalNumParcelasInput.value) || 0); // Gera campos se manual
                 }
             });
         });
        installmentMethodRadios.forEach(radio => {
             radio.addEventListener('change', (e) => {
                 const isIntervalo = e.target.value === 'intervalo';
                 intervalInputsDiv.classList.toggle('hidden', !isIntervalo);
                 manualDatesContainer.classList.toggle('hidden', isIntervalo);
                 if (!isIntervalo) gerarCamposDataManual(parseInt(modalNumParcelasInput.value) || 0); // Gera campos se manual
             });
         });
        modalNumParcelasInput.addEventListener('input', () => {
             const metodoSelecionado = document.querySelector('input[name="metodoParcela"]:checked').value;
             if (metodoSelecionado === 'manual') { gerarCamposDataManual(parseInt(modalNumParcelasInput.value) || 0); }
         });

        // --- Funções de Cálculo e Persistência ---

        function calcularDatasParcelas(dataInicioStr, numParcelas, intervaloDias) {
            const datas = [];
            let dataAtual = dataStringToDate(dataInicioStr);
            if (!dataAtual || numParcelas < 1 || intervaloDias < 1) return datas;
            for (let i = 0; i < numParcelas; i++) {
                datas.push(dateToYYYYMMDD(dataAtual));
                dataAtual = addDays(dataAtual, intervaloDias);
            }
            return datas;
        }

        async function limparRecebimentosAntigos(pedidoId) {
            // ... (igual anterior, sem mudanças) ...
             console.log(`Iniciando limpeza de recebimentos antigos para pedido ${pedidoId}`);
             const recebimentosRef = collection(db, "recebimentos");
             const q = query(recebimentosRef, where("pedidoId", "==", pedidoId));
             try {
                 const snapshot = await getDocs(q);
                 if (!snapshot.empty) {
                     console.log(`Encontrados ${snapshot.size} recebimentos antigos para excluir.`);
                     const batch = writeBatch(db);
                     snapshot.forEach(doc => {
                         console.log(`Agendando exclusão de recebimento ${doc.id}`);
                         batch.delete(doc.ref);
                     });
                     await batch.commit();
                     console.log("Recebimentos antigos excluídos com sucesso.");
                 } else {
                     console.log("Nenhum recebimento antigo encontrado para este pedido.");
                 }
             } catch (error) {
                 console.error(`Erro ao limpar recebimentos antigos para pedido ${pedidoId}:`, error);
                 throw new Error("Falha ao limpar pagamentos anteriores.");
             }
         }

        async function salvarConfiguracaoPagamento() {
             // ... (igual anterior, usa clienteInfo atualizado) ...
              const pedidoId = modalPedidoIdInput.value;
              const pedidoTotal = parseFloat(modalPedidoTotalInput.value) || 0;
              let clienteInfo = {}; try { clienteInfo = JSON.parse(modalClienteInfoInput.value || '{}'); } catch(e){console.error("Erro parse clienteInfo ao salvar",e);}
              const dataEntrega = modalDataEntregaInput.value || null;
              const tipoPagamento = document.querySelector('input[name="tipoPagamento"]:checked').value;

              if (!pedidoId) { alert("Erro: ID do Pedido não encontrado no modal."); return; }

              const pedidoRef = doc(db, "pedidos", pedidoId);
              let numeroDoPedidoParaDesc = pedidoId.substring(0,6).toUpperCase();
              try { const pedidoSnap = await getDoc(pedidoRef); if (pedidoSnap.exists()) { numeroDoPedidoParaDesc = pedidoSnap.data().numeroPedido || numeroDoPedidoParaDesc; } } catch (e) {}

              btnSalvarConfigPagamento.disabled = true; btnSalvarConfigPagamento.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

              try {
                  await limparRecebimentosAntigos(pedidoId);

                  const batch = writeBatch(db);
                  const updateDataPedido = {};
                   if (dataEntrega) updateDataPedido.dataEntregaOficial = dataEntrega; else updateDataPedido.dataEntregaOficial = deleteField();

                  let parcelamentoInfoSalvar = null;

                  if (tipoPagamento === 'unico') {
                      const dataPagamentoUnico = modalDataPagamentoUnicoInput.value;
                      if (!dataPagamentoUnico) throw new Error("Selecione a data para pagamento único.");

                      updateDataPedido.dataPagamentoOficial = dataPagamentoUnico;
                      updateDataPedido.parcelamentoInfo = deleteField();

                      const recebimentoRef = doc(collection(db, "recebimentos"));
                      batch.set(recebimentoRef, {
                          descricao: `Pagamento Pedido #${numeroDoPedidoParaDesc}`, valor: pedidoTotal, dataPagamento: dataPagamentoUnico, // Usar dataPagamento para vencimento
                          pago: false, pedidoId: pedidoId, clienteId: clienteInfo.id || null, clienteNome: clienteInfo.nome || null,
                          telefone: clienteInfo.telefone || null, createdAt: Timestamp.now()
                      });

                  } else { // Parcelado
                      const numParcelas = parseInt(modalNumParcelasInput.value) || 0;
                      let valorParcela = parseFloat(modalValorParcelaInput.value) || 0;
                      const metodoParcela = document.querySelector('input[name="metodoParcela"]:checked').value;

                      if (numParcelas < 1) throw new Error("Número de parcelas inválido.");
                      if (valorParcela <= 0) { if (pedidoTotal > 0 && numParcelas > 0) valorParcela = parseFloat((pedidoTotal / numParcelas).toFixed(2)); else throw new Error("Não foi possível calcular valor da parcela."); }
                      if (Math.abs((valorParcela * numParcelas) - pedidoTotal) > (numParcelas * 0.011)) { if(!confirm(`A soma das parcelas (${formatarValorBRL(valorParcela * numParcelas)}) difere do total (${formatarValorBRL(pedidoTotal)}). Continuar?`)) { throw new Error("Cálculo cancelado."); } }

                      let datasParcelas = [];
                      updateDataPedido.dataPagamentoOficial = deleteField();

                      if (metodoParcela === 'intervalo') {
                          const dataPrimeira = modalDataPrimeiraParcelaInput.value;
                          const intervalo = parseInt(modalIntervaloParcelasInput.value) || 30;
                          if (!dataPrimeira || intervalo < 1) throw new Error("Informe data inicial e intervalo válidos.");
                          datasParcelas = calcularDatasParcelas(dataPrimeira, numParcelas, intervalo);
                          parcelamentoInfoSalvar = { modo: 'intervalo', numero: numParcelas, valor: valorParcela, dataInicio: dataPrimeira, intervalo: intervalo };
                      } else { // Manual
                          const inputsDataManual = manualDatesGrid.querySelectorAll('input[type="date"]');
                          if (inputsDataManual.length !== numParcelas) throw new Error(`Nº de campos (${inputsDataManual.length}) diferente do Nº de Parcelas (${numParcelas}).`);
                          datasParcelas = Array.from(inputsDataManual).map((input, i) => { if (!input.value) throw new Error(`Preencha a data ${i + 1}.`); return input.value; });
                          datasParcelas.sort();
                          parcelamentoInfoSalvar = { modo: 'manual', numero: numParcelas, valor: valorParcela, datas: datasParcelas };
                      }

                      if (datasParcelas.length !== numParcelas) throw new Error("Erro ao obter datas das parcelas.");

                      for (let i = 0; i < numParcelas; i++) {
                          const recebimentoRef = doc(collection(db, "recebimentos"));
                          batch.set(recebimentoRef, {
                              descricao: `Parcela ${i + 1}/${numParcelas} Pedido #${numeroDoPedidoParaDesc}`, valor: valorParcela, dataPagamento: datasParcelas[i], // Usar dataPagamento para vencimento
                              pago: false, parcelaNum: i + 1, parcelaTotal: numParcelas, pedidoId: pedidoId, clienteId: clienteInfo.id || null, clienteNome: clienteInfo.nome || null,
                              telefone: clienteInfo.telefone || null, createdAt: Timestamp.now()
                          });
                      }
                      updateDataPedido.parcelamentoInfo = parcelamentoInfoSalvar;
                  }

                  batch.update(pedidoRef, updateDataPedido);
                  await batch.commit();

                  alert("Configuração de pagamento salva com sucesso!");
                  fecharModalConfiguracaoPagamento();
                  await carregarPedidos();

              } catch (error) {
                  console.error("Erro ao salvar configuração:", error);
                  alert(`Erro ao salvar: ${error.message}`);
              } finally {
                  btnSalvarConfigPagamento.disabled = false; btnSalvarConfigPagamento.innerHTML = '<i class="fas fa-save"></i> Salvar Configuração';
              }
         }

        async function removerConfiguracaoPagamento() {
              // ... (igual anterior, sem mudanças) ...
              const pedidoId = modalPedidoIdInput.value;
              if (!pedidoId) { alert("Erro: ID do Pedido não encontrado."); return; }
              if (!confirm("Tem certeza que deseja remover TODA a configuração de pagamento e os recebimentos associados a este pedido?")) return;

              btnRemoverConfigPagamento.disabled = true; btnRemoverConfigPagamento.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removendo...';

              try {
                  await limparRecebimentosAntigos(pedidoId);
                  const pedidoRef = doc(db, "pedidos", pedidoId);
                  await updateDoc(pedidoRef, {
                      dataPagamentoOficial: deleteField(),
                      parcelamentoInfo: deleteField()
                  });
                  alert("Configuração de pagamento removida com sucesso!");
                  fecharModalConfiguracaoPagamento();
                  await carregarPedidos();
              } catch (error) {
                  console.error("Erro ao remover configuração:", error);
                  alert(`Erro ao remover: ${error.message}`);
              } finally {
                  btnRemoverConfigPagamento.disabled = false; btnRemoverConfigPagamento.innerHTML = '<i class="fas fa-times-circle"></i> Remover Config. Pagamento';
              }
          }

        // --- Event Listeners ---
        filtroClienteSelect.addEventListener('change', aplicarFiltros);
        filtroStatusEntregaSelect.addEventListener('change', aplicarFiltros);
        filtroStatusPagamentoSelect.addEventListener('change', aplicarFiltros);
        buscaNumeroPedidoInput.addEventListener('input', aplicarFiltros);
        btnLimparFiltros.addEventListener('click', () => {
            filtroClienteSelect.value = '';
            filtroStatusEntregaSelect.value = '';
            filtroStatusPagamentoSelect.value = '';
            buscaNumeroPedidoInput.value = '';
            aplicarFiltros();
        });
        closePaymentModalBtn.addEventListener('click', fecharModalConfiguracaoPagamento);
        cancelPaymentModalBtn.addEventListener('click', fecharModalConfiguracaoPagamento);
        btnSalvarConfigPagamento.addEventListener('click', salvarConfiguracaoPagamento);
        btnRemoverConfigPagamento.addEventListener('click', removerConfiguracaoPagamento);
        window.addEventListener('click', (event) => { if (event.target == paymentConfigModal) fecharModalConfiguracaoPagamento(); });

        // --- Inicialização ---
        window.addEventListener("load", async () => {
            console.log("Página Gestão de Pedidos v4 (Responsiva) Inicializada.");
            await carregarClientesFiltro();
            await carregarPedidos();
        });

    </script>
</body>
</html>