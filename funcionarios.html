<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Funcionários v2.3 - Exclusão Aprimorada</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- Estilos Gerais --- */
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
            --light-color: #f8f9fa; --dark-color: #343a40; --border-color: #dee2e6;
            --background-color: #eef1f5; --card-background: #ffffff; --text-color: #495057;
            --text-muted: #6c757d; --shadow-sm: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            --shadow-md: 0 0.5rem 1rem rgba(0,0,0,0.1); --border-radius: 0.375rem;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; font-size: 16px; padding: 20px; }
        .container { background-color: var(--card-background); padding: 25px 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); max-width: 1200px; margin: 20px auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .page-header h1 { font-size: 1.8rem; font-weight: 500; color: var(--dark-color); margin: 0; }
        .page-header .actions { display: flex; gap: 10px; }

        /* Formulário de Cadastro/Edição */
        #form-funcionario-modal { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-muted); font-size: 0.85rem; }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"],
        .form-group input[type="number"], .form-group input[type="date"], .form-group select {
            width: 100%; padding: 8px 10px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius); font-size: 0.95rem; height: 38px;
        }
        .form-group input[type="checkbox"] + label { display: inline; font-weight: normal; font-size: 0.9rem; margin-bottom: 0; vertical-align: middle; cursor:pointer;}
        .form-group input[type="checkbox"] { width: auto; height: auto; margin-right: 5px; vertical-align: middle; cursor:pointer;}
        #form-funcionario-modal .full-width { grid-column: span 2; }

        /* Parcelas de Pagamento Dinâmicas */
        #parcelas-container .parcela-input-pair { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        #parcelas-container .parcela-input-pair input[type="number"] { height: 34px; padding: 6px 8px; flex-grow: 1; }
        #parcelas-container .parcela-input-pair input.parcela-dia { width: 80px; flex-grow: 0; }
        #parcelas-container .parcela-input-pair .btn-remove-parcela { padding: 4px 8px; height: 34px; flex-shrink: 0; }
        #parcelas-total-percentual.invalid { color: var(--danger-color); }
        #parcelas-total-percentual.valid { color: var(--success-color); }

        /* Área de Busca/Filtro */
        .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; background-color: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-bottom: 25px; }
        .filter-controls > div { flex: 1 1 200px; min-width: 180px; }
        .filter-controls label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-muted); font-size: 0.85rem; }
        .filter-controls input[type="text"], .filter-controls select { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; height: 38px; }
        .filter-controls button { padding: 8px 15px; font-size: 0.9rem; height: 38px; flex-shrink: 0; }

        /* Tabela */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 0.95rem; }
        th, td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; vertical-align: middle; }
        th { background-color: var(--light-color); font-weight: 500; color: var(--text-muted); white-space: nowrap; font-size: 0.85rem; }
        tbody tr:nth-child(even) { background-color: #fdfdfe; }
        tbody tr:hover { background-color: #f1f1f1; }
        .col-actions { text-align: center; white-space: nowrap; width: 1%; }
        .col-tipo { text-align: center; white-space: nowrap; }
        .col-salario { text-align: right; white-space: nowrap; }
        .col-parcelas { text-align: left; white-space: normal; }

        /* Botões */
        button, .button-link { display: inline-block; padding: 8px 15px; font-size: 0.9rem; font-weight: 500; text-align: center; white-space: nowrap; vertical-align: middle; user-select: none; border: 1px solid transparent; border-radius: var(--border-radius); transition: all 0.15s ease-in-out; cursor: pointer; text-decoration: none; }
        button i, .button-link i { margin-right: 5px; }
        button:disabled { opacity: 0.65; cursor: not-allowed; }
        .btn-primary { color: #fff; background-color: var(--primary-color); border-color: var(--primary-color); } .btn-primary:hover { background-color: #0056b3; border-color: #004085; }
        .btn-success { color: #fff; background-color: var(--success-color); border-color: var(--success-color); } .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .btn-danger { color: #fff; background-color: var(--danger-color); border-color: var(--danger-color); } .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .btn-info { color: #fff; background-color: var(--info-color); border-color: var(--info-color); } .btn-info:hover { background-color: #138496; border-color: #117a8b; }
        .btn-warning { color: #212529; background-color: var(--warning-color); border-color: var(--warning-color); } .btn-warning:hover { background-color: #e0a800; border-color: #d39e00;}
        .btn-secondary { color: #fff; background-color: var(--secondary-color); border-color: var(--secondary-color); } .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; margin: 0 2px; }

        /* Modais */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #ddd; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 1.4em; }
        .close-modal-btn { color: #aaa; background: none; border: none; font-size: 28px; font-weight: bold; cursor: pointer; padding: 0 5px; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: black; }
        .modal-footer { text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .modal-footer button { margin-left: 10px; }

        /* Modal Histórico Pagamentos */
        #payment-history-modal .modal-content { max-width: 750px; }
        #payment-history-modal h3 { font-size: 1.1em; margin-top: 15px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        #payment-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; }
        #payment-list li { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: var(--border-radius); padding: 10px 15px; margin-bottom: 10px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        #payment-list li strong { color: var(--dark-color); margin-right: 5px; font-size: 0.85rem; }
        #payment-list li .payment-details { flex-grow: 1; display: flex; flex-wrap: wrap; align-items: center; gap: 5px 10px; }
        #payment-list li .payment-details span { color: var(--text-muted); }
        #payment-list li .payment-details .description { font-style: italic; flex-basis: 100%;}
        #payment-list li .payment-details .value { font-weight: bold; color: var(--danger-color); }
        #payment-list li .payment-details .date { font-size: 0.85rem; font-style: normal; }
        #payment-list li .payment-actions { flex-shrink: 0; display: flex; gap: 5px;}
        #payment-list li .payment-actions button { padding: 3px 8px; font-size: 0.75rem; }
        .status-pago { color: var(--success-color); font-weight: bold; white-space: nowrap; }
        .status-pendente { color: var(--warning-color); font-weight: bold; white-space: nowrap; }
        .status-pago i, .status-pendente i { margin-right: 3px; }

        /* Modal Adicionar Pagamento */
        #add-payment-modal .modal-content { max-width: 500px; }

        /* Loading/Empty Messages */
        #loading-message, #empty-message, #loading-all-payments-message, #empty-all-payments-message {
            text-align: center; padding: 20px; color: var(--text-muted); font-size: 1.1rem;
        }
        #empty-history-message { text-align: center; padding: 15px 0; color: var(--text-muted); font-size: 1rem;}

        /* Tabela de Todos os Pagamentos - Colunas específicas */
        #tabela-todos-pagamentos .col-funcionario-pgto { width: 20%; }
        #tabela-todos-pagamentos .col-tipo-pgto { width: 10%; text-align:center; }
        #tabela-todos-pagamentos .col-descricao-pgto { width: 30%; }
        #tabela-todos-pagamentos .col-valor-pgto { width: 10%; text-align:right; }
        #tabela-todos-pagamentos .col-data-pgto { width: 10%; text-align:center; }
        #tabela-todos-pagamentos .col-status-pgto { width: 10%; text-align:center; }
        #tabela-todos-pagamentos .col-criado-pgto { width: 10%; text-align:center; }


        @media (max-width: 767.98px) { /* Ajustes responsivos mantidos */
            body { padding: 10px; font-size: 15px; }
            .container { padding: 15px; }
            .page-header { flex-direction: column; align-items: flex-start; margin-bottom: 20px; }
            .page-header h1 { font-size: 1.5rem; margin-bottom: 10px; }
            .page-header .actions { width: 100%; justify-content: space-between; flex-direction: column; gap: 8px;}
            .page-header .actions button { flex-grow: 1; margin: 0;}

            #form-funcionario-modal { grid-template-columns: 1fr; gap: 12px; }
            #form-funcionario-modal .full-width { grid-column: span 1; }
            .filter-controls { flex-direction: column; gap: 12px; padding: 12px; }
            .filter-controls > div { flex: 1 1 auto; min-width: 0; width: 100%; }
            .filter-controls button { width: 100%; margin-top: 5px; }
            th, td { padding: 8px; font-size: 0.9rem; }
            .col-actions button { padding: 5px 8px; font-size: 0.8rem; margin-bottom: 3px; }
            .col-actions { white-space: normal; }
            .modal-content { width: 95%; margin: 15px auto; padding: 20px; }
            .modal-header h2 { font-size: 1.25rem; }
            #payment-list li { flex-direction: column; align-items: flex-start; }
            #payment-list li .payment-details .description { flex-basis: auto; }
            #payment-list li .payment-actions { margin-top: 8px; width: 100%; justify-content: flex-end; }
            .modal-footer { display: flex; flex-direction: column; gap: 10px; align-items: stretch;}
            .modal-footer button { margin-left: 0; width: 100%;}
        }
        @media (max-width: 479.98px) { /* Ajustes responsivos mantidos */
            body { font-size: 14px; }
            .page-header h1 { font-size: 1.3rem; }
            th, td { font-size: 0.85rem; padding: 6px; }
            .col-actions button { font-size: 0.75rem; padding: 4px 6px; }
            .modal-content { padding: 15px; }
            .modal-header h2 { font-size: 1.1rem; }
            #payment-list li .payment-actions { justify-content: space-around; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>Cadastro de Funcionários</h1>
            <div class="actions">
                <button id="btn-view-all-payments" class="btn-info"><i class="fas fa-list-ul"></i> Todos Pagamentos</button>
                <button id="btn-add-funcionario" class="btn-success"><i class="fas fa-user-plus"></i> Novo Funcionário</button>
            </div>
        </div>

        <div class="filter-controls">
            <div> <label for="busca-funcionario">Buscar Funcionário</label> <input type="text" id="busca-funcionario" placeholder="Nome..."> </div>
            <div> <label for="filtro-tipo">Tipo</label> <select id="filtro-tipo"><option value="">Todos</option><option value="fixo">Fixo</option><option value="freelancer">Freelancer</option></select> </div>
            <button id="btn-limpar-filtros" class="btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
        </div>

        <div class="table-container">
            <table id="tabela-funcionarios">
                <thead> <tr> <th>Nome Completo</th> <th class="col-tipo">Tipo</th> <th>Contato</th> <th class="col-salario">Salário Fixo</th> <th class="col-parcelas">Parcelas Pagamento</th> <th class="col-actions">Ações</th> </tr> </thead>
                <tbody id="tabela-funcionarios-body"></tbody>
            </table>
            <div id="loading-message" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
            <div id="empty-message" style="display: none;">Nenhum funcionário cadastrado.</div>
        </div>
    </div>

    <div id="todos-pagamentos-container" class="container" style="display: none; margin-top: 30px;">
        <div class="page-header"> <h2>Todos os Lançamentos Financeiros</h2> <button id="btn-close-all-payments-view" class="btn-secondary btn-sm">Fechar Visualização</button> </div>
        <div class="table-container">
            <table id="tabela-todos-pagamentos">
                <thead> <tr> <th class="col-funcionario-pgto">Funcionário</th> <th class="col-tipo-pgto">Tipo</th> <th class="col-descricao-pgto">Descrição</th> <th class="col-valor-pgto">Valor (R$)</th> <th class="col-data-pgto">Data Pag./Venc.</th> <th class="col-status-pgto">Status</th> <th class="col-criado-pgto">Criado em</th> <th class="col-actions">Ações</th> </tr> </thead>
                <tbody id="tabela-todos-pagamentos-body"></tbody>
            </table>
            <div id="loading-all-payments-message" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
            <div id="empty-all-payments-message" style="display: none;">Nenhum lançamento.</div>
        </div>
    </div>

    <div id="funcionario-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-funcionario-title">Novo Funcionário</h2> <button class="close-modal-btn" data-modal-id="funcionario-modal">&times;</button> </div>
            <form id="form-funcionario-modal" novalidate> <input type="hidden" id="funcionario-id">
                <div class="form-group full-width"> <label for="nome-completo">Nome Completo</label> <input type="text" id="nome-completo" required> </div>
                <div class="form-group"> <label for="telefone">Telefone</label> <input type="tel" id="telefone" placeholder="+55 (99) 91234-5678"> </div>
                <div class="form-group"> <label for="email">E-mail</label> <input type="email" id="email"> </div>
                <div class="form-group"> <label for="tipo-funcionario">Tipo</label> <select id="tipo-funcionario" required><option value="">Selecione...</option><option value="fixo">Fixo</option><option value="freelancer">Freelancer</option></select> </div>
                <div class="form-group" id="salario-fixo-group" style="display: none;"> <label for="salario-mensal">Salário Mensal (R$)</label> <input type="number" id="salario-mensal" step="0.01" min="0.01"> </div>
                <div class="form-group full-width" id="parcelas-pagamento-group" style="display: none;"> <label>Parcelas de Pagamento Fixo (Dia e %)</label> <div id="parcelas-container"></div> <button type="button" id="btn-add-parcela" class="btn-secondary btn-sm" style="margin-top: 10px;"><i class="fas fa-plus"></i> Adicionar Parcela</button> <small id="parcelas-total-percentual" style="display: block; margin-top: 8px; font-weight: bold; color: var(--dark-color);"></small> <small class="form-text text-muted" style="display: block; margin-top: 3px;">Informe os dias e percentuais. Soma deve ser 100%.</small> <div id="parcelas-validation-error" style="color: var(--danger-color); font-size: 0.85rem; margin-top: 5px; display: none;"></div> </div>
            </form>
            <div class="modal-footer"> <button type="button" class="btn-secondary close-modal-btn" data-modal-id="funcionario-modal">Cancelar</button> <button type="submit" form="form-funcionario-modal" class="btn-primary" id="salvar-funcionario-btn">Salvar</button> </div>
        </div>
    </div>

    <div id="payment-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-history-title">Histórico de Pagamentos - <span id="history-funcionario-nome"></span></h2> <button class="close-modal-btn" data-modal-id="payment-history-modal">&times;</button> </div>
            <div class="modal-body"> <button id="btn-add-payment" class="btn-success btn-sm" style="margin-bottom: 15px;"><i class="fas fa-plus"></i> Adicionar Pagamento/Adiantamento</button> <h3>Lançamentos</h3> <ul id="payment-list"></ul> <div id="empty-history-message" style="display: none;">Nenhum lançamento.</div> </div>
            <div class="modal-footer"> <button type="button" class="btn-secondary close-modal-btn" data-modal-id="payment-history-modal">Fechar</button> </div>
        </div>
    </div>

    <div id="add-payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-add-payment-title">Novo Lançamento Financeiro</h2> <button class="close-modal-btn" data-modal-id="add-payment-modal">&times;</button> </div>
            <form id="form-add-payment" novalidate> <input type="hidden" id="payment-funcionario-id">
                <div class="form-group full-width"> <label for="payment-tipo">Tipo de Lançamento</label> <select id="payment-tipo" required><option value="salario">Salário (Fixo)</option><option value="adiantamento">Adiantamento</option><option value="freelancer">Pagamento Freelancer</option></select> </div>
                <div class="form-group full-width"> <label for="payment-descricao">Descrição</label> <input type="text" id="payment-descricao" placeholder="Ex: Salário Ref. Out/25 (Dia 5 - 40%)" required> </div>
                <div class="form-group"> <label for="payment-valor">Valor (R$)</label> <input type="number" id="payment-valor" step="0.01" min="0.01" required> </div>
                <div class="form-group"> <label for="payment-data">Data Pagamento/Vencimento</label> <input type="date" id="payment-data" required> </div>
                <div class="form-group full-width" style="flex-direction: row; align-items: center;"> <input type="checkbox" id="payment-is-paid"> <label for="payment-is-paid">Marcar como Pago</label> </div>
            </form>
            <div class="modal-footer"> <button type="button" class="btn-secondary close-modal-btn" data-modal-id="add-payment-modal">Cancelar</button> <button type="submit" form="form-add-payment" class="btn-primary" id="salvar-pagamento-btn">Registrar Lançamento</button> </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, orderBy, where, addDoc, deleteDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVkb1-tdd5SL8jA2Cw2B0aeugu8SaCUBc",
            authDomain: "testebosspro.firebaseapp.com",
            projectId: "testebosspro",
            storageBucket: "testebosspro.appspot.com",
            messagingSenderId: "73684788134",
            appId: "1:73684788134:web:7c8250c83f10a2df59e567",
            measurementId: "G-1H29L5B830"
        };

        let app;
        let db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("LOG: Firebase conectado com sucesso!");
        } catch (error) {
            console.error("ERRO CRÍTICO: Falha ao inicializar Firebase:", error.message);
            alert("FALHA NA CONEXÃO COM O BANCO DE DADOS!");
            const btnAddMain = document.getElementById('btn-add-funcionario'); if (btnAddMain) btnAddMain.disabled = true;
            const loadingMain = document.getElementById('loading-message'); if (loadingMain) { loadingMain.textContent = "Erro de conexão."; loadingMain.style.display = 'block';}
            const emptyMain = document.getElementById('empty-message'); if(emptyMain) emptyMain.style.display = 'none';
        }

        const tabelaBody = document.getElementById('tabela-funcionarios-body');
        const loadingMessage = document.getElementById('loading-message');
        const emptyMessage = document.getElementById('empty-message');
        const buscaFuncionarioInput = document.getElementById('busca-funcionario');
        const filtroTipoSelect = document.getElementById('filtro-tipo');
        const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
        let btnAddFuncionario = document.getElementById('btn-add-funcionario');
        const funcionarioModal = document.getElementById('funcionario-modal');
        const modalFuncionarioTitle = document.getElementById('modal-funcionario-title');
        const formFuncionarioModal = document.getElementById('form-funcionario-modal');
        const funcionarioIdInput = document.getElementById('funcionario-id');
        const nomeCompletoInput = document.getElementById('nome-completo');
        const telefoneInput = document.getElementById('telefone');
        const emailInput = document.getElementById('email');
        const tipoFuncionarioSelect = document.getElementById('tipo-funcionario');
        const salarioFixoGroup = document.getElementById('salario-fixo-group');
        const salarioMensalInput = document.getElementById('salario-mensal');
        const parcelasPagamentoGroup = document.getElementById('parcelas-pagamento-group');
        const parcelasContainer = document.getElementById('parcelas-container');
        const btnAddParcela = document.getElementById('btn-add-parcela');
        const parcelasTotalPercentualSpan = document.getElementById('parcelas-total-percentual');
        const parcelasValidationErrorDiv = document.getElementById('parcelas-validation-error');
        const salvarFuncionarioBtn = document.getElementById('salvar-funcionario-btn');
        const paymentHistoryModal = document.getElementById('payment-history-modal');
        const historyFuncionarioNomeSpan = document.getElementById('history-funcionario-nome');
        const paymentList = document.getElementById('payment-list');
        const emptyHistoryMessage = document.getElementById('empty-history-message');
        let btnAddPayment = document.getElementById('btn-add-payment');
        const addPaymentModal = document.getElementById('add-payment-modal');
        const formAddPayment = document.getElementById('form-add-payment');
        const paymentFuncionarioIdInput = document.getElementById('payment-funcionario-id');
        const paymentTipoSelect = document.getElementById('payment-tipo');
        const paymentDescricaoInput = document.getElementById('payment-descricao');
        const paymentValorInput = document.getElementById('payment-valor');
        const paymentDataInput = document.getElementById('payment-data');
        const paymentIsPaidCheckbox = document.getElementById('payment-is-paid');
        const salvarPagamentoBtn = document.getElementById('salvar-pagamento-btn');
        const closeModalsBtns = document.querySelectorAll('.close-modal-btn');
        const todosPagamentosContainer = document.getElementById('todos-pagamentos-container');
        const btnViewAllPayments = document.getElementById('btn-view-all-payments');
        const btnCloseAllPaymentsView = document.getElementById('btn-close-all-payments-view');
        const tabelaTodosPagamentosBody = document.getElementById('tabela-todos-pagamentos-body');
        const loadingAllPaymentsMessage = document.getElementById('loading-all-payments-message');
        const emptyAllPaymentsMessage = document.getElementById('empty-all-payments-message');

        let todosFuncionariosArray = [];
        let funcionarioSelecionadoParaPagamento = null;

        function formatarValorBRL(valor) { return `R$ ${(parseFloat(valor) || 0).toFixed(2).replace('.', ',')}`; }
        function formatarDataExibicao(dataString) { if (!dataString || dataString.length < 10) return 'N/A'; try { const [y, m, d] = dataString.substring(0,10).split('-'); if (y && m && d && y.length === 4) return `${d}/${m}/${y}`; return 'Data Inválida'; } catch { return 'Inválida'; } }
        function formatarTelefone(telefone) {
            if (!telefone) return 'N/A'; const cleaned = ('' + telefone).replace(/\D/g, '');
            if (cleaned.length === 11 && cleaned.startsWith('55')) { const match = cleaned.match(/^(\d{2})(\d{2})(9\d{4})(\d{4})$/); if (match) return `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}`; }
            else if (cleaned.length === 11 && cleaned[2] === '9') { const match = cleaned.match(/^(\d{2})(9\d{4})(\d{4})$/); if (match) return `(${match[1]}) ${match[2]}-${match[3]}`; }
            else if (cleaned.length === 10) { const match = cleaned.match(/^(\d{2})(\d{4})(\d{4})$/); if (match) return `(${match[1]}) ${match[2]}-${match[3]}`; }
            else if (cleaned.length === 9 && cleaned[0] === '9') { const match = cleaned.match(/^(9\d{4})(\d{4})$/); if (match) return `${match[1]}-${match[2]}`; }
            else if (cleaned.length === 8) { const match = cleaned.match(/^(\d{4})(\d{4})$/); if (match) return `${match[1]}-${match[2]}`; }
            return telefone;
        }
        function formatarParcelasParaExibicao(parcelas) {
            if (!parcelas || parcelas.length === 0) return 'N/A'; const parcelasOrdenadas = [...parcelas].sort((a, b) => a.dia - b.dia);
            return parcelasOrdenadas.map(p => `Dia ${p.dia} (${(p.percentual || 0).toFixed(2).replace('.', ',')}%)`).join(', ');
        }
        function getTodayDateString() { const today = new Date(); return dateToYYYYMMDD(today); }
        function dateToYYYYMMDD(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
            const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getMonthName(monthIndex) {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            if (monthIndex >= 0 && monthIndex < months.length) { return months[monthIndex]; } return 'Mês Inválido';
        }

        async function carregarFuncionarios() {
            if (!db) { console.error("LOG: Firestore não inicializado. Carregamento de funcionários cancelado."); return; }
            loadingMessage.style.display = 'block'; emptyMessage.style.display = 'none'; tabelaBody.innerHTML = '';
            todosFuncionariosArray = [];
            try {
                const q = query(collection(db, "funcionarios"), orderBy("nomeCompleto"));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => { todosFuncionariosArray.push({ id: doc.id, ...doc.data() }); });
                console.log(`LOG: ${todosFuncionariosArray.length} funcionários carregados.`);
                await generateRecurringPayments();
                console.log("LOG: Verificação/geração de pagamentos recorrentes (fixo) concluída.");
                aplicarFiltrosFuncionarios();
            } catch (error) { console.error("Erro ao carregar funcionários ou gerar pagamentos:", error); emptyMessage.textContent = "Erro ao carregar dados."; emptyMessage.style.display = 'block';
            } finally { loadingMessage.style.display = 'none'; }
        }
        function aplicarFiltrosFuncionarios() {
            const termoBusca = buscaFuncionarioInput.value.trim().toLowerCase(); const tipoFiltro = filtroTipoSelect.value;
            const funcionariosFiltrados = todosFuncionariosArray.filter(funcionario => {
                const matchNome = !termoBusca || (funcionario.nomeCompleto && funcionario.nomeCompleto.toLowerCase().includes(termoBusca));
                const matchTipo = !tipoFiltro || (funcionario.tipo && funcionario.tipo === tipoFiltro);
                return matchNome && matchTipo;
            });
            renderizarTabelaFuncionarios(funcionariosFiltrados);
        }
        function renderizarTabelaFuncionarios(funcionariosParaRenderizar) {
            tabelaBody.innerHTML = '';
            if (funcionariosParaRenderizar.length === 0 && db) {
                emptyMessage.style.display = 'block';
                emptyMessage.textContent = buscaFuncionarioInput.value || filtroTipoSelect.value ? "Nenhum funcionário encontrado com os filtros." : "Nenhum funcionário cadastrado.";
            } else if (funcionariosParaRenderizar.length > 0){
                emptyMessage.style.display = 'none';
                funcionariosParaRenderizar.forEach(funcionario => {
                    const tr = document.createElement('tr'); tr.dataset.funcionarioId = funcionario.id;
                    const parcelasFormatadas = funcionario.tipo === 'fixo' ? formatarParcelasParaExibicao(funcionario.parcelasPagamento) : 'N/A';
                    tr.innerHTML = `
                        <td>${funcionario.nomeCompleto || 'N/A'}</td>
                        <td class="col-tipo">${funcionario.tipo === 'fixo' ? 'Fixo' : (funcionario.tipo === 'freelancer' ? 'Freelancer' : 'N/A')}</td>
                        <td>${funcionario.telefone ? formatarTelefone(funcionario.telefone) : 'N/A'}${funcionario.email ? '<br>' + funcionario.email : ''}</td>
                        <td class="col-salario">${funcionario.tipo === 'fixo' && funcionario.salarioMensal != null ? formatarValorBRL(funcionario.salarioMensal) : 'N/A'}</td>
                        <td class="col-parcelas">${parcelasFormatadas}</td>
                        <td class="col-actions">
                            <button class="btn-info btn-sm btn-view-payments" title="Ver/Gerenciar Pagamentos"><i class="fas fa-dollar-sign"></i> Pgts</button>
                            <button class="btn-warning btn-sm btn-edit-funcionario" title="Editar Funcionário"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-danger btn-sm btn-delete-funcionario" title="Excluir Funcionário"><i class="fas fa-trash-alt"></i> Del</button>
                        </td>`;
                    tabelaBody.appendChild(tr);
                });
                addListenersBotoesTabela();
            } else if (!db) {
                tabelaBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--danger-color);">Erro de conexão com o banco de dados.</td></tr>';
            }
        }
        // MODIFICADO: addListenersBotoesTabela para incluir nova lógica de exclusão
        function addListenersBotoesTabela() {
            if (!db) return;
            document.querySelectorAll('.btn-view-payments').forEach(btn => { const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.addEventListener('click', (e) => { const funcionarioId = e.currentTarget.closest('tr').dataset.funcionarioId; const funcionario = todosFuncionariosArray.find(f => f.id === funcionarioId); if (funcionario) { funcionarioSelecionadoParaPagamento = funcionario; abrirModalHistoricoPagamentos(funcionario); } else { console.error("Funcionário não encontrado no array local:", funcionarioId); alert("Erro: Não foi possível encontrar os dados deste funcionário.");}});});
            document.querySelectorAll('.btn-edit-funcionario').forEach(btn => { const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.addEventListener('click', (e) => { const funcionarioId = e.currentTarget.closest('tr').dataset.funcionarioId; abrirModalEdicaoFuncionario(funcionarioId); });});

            document.querySelectorAll('.btn-delete-funcionario').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', async (e) => {
                    if (!db) { console.error("Firestore não inicializado."); return; }
                    const tr = e.currentTarget.closest('tr');
                    const funcionarioId = tr.dataset.funcionarioId;
                    const funcionarioNome = tr.cells[0].textContent;

                    if (!confirm(`Tem certeza que deseja excluir o funcionário "${funcionarioNome}"?`)) return;

                    const deleteButton = e.currentTarget;
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    try {
                        const hojeStr = dateToYYYYMMDD(new Date());
                        let pagamentosManipulados = false;

                        if (confirm("Deseja também excluir TODOS os lançamentos de pagamentos FUTUROS e PENDENTES associados a este funcionário?\nPagamentos passados ou já realizados serão mantidos (apenas desvinculados).")) {
                            // Opção SIM: Excluir futuros/pendentes, desvincular os demais
                            const pagamentosQuery = query(collection(db, "pagamentos"), where("funcionarioId", "==", funcionarioId));
                            const pagamentosSnapshot = await getDocs(pagamentosQuery);
                            const batch = writeBatch(db);
                            let pagamentosFuturosPendentesExcluidos = 0;
                            let pagamentosMantidosDesvinculados = 0;

                            pagamentosSnapshot.forEach(docPag => {
                                const pagamentoData = docPag.data();
                                // Considera dataPagamento como string 'YYYY-MM-DD'
                                if (pagamentoData.dataPagamento >= hojeStr && !pagamentoData.pago) {
                                    batch.delete(docPag.ref);
                                    pagamentosFuturosPendentesExcluidos++;
                                } else {
                                    batch.update(docPag.ref, { funcionarioId: null });
                                    pagamentosMantidosDesvinculados++;
                                }
                            });

                            if (pagamentosFuturosPendentesExcluidos > 0 || pagamentosMantidosDesvinculados > 0) {
                                await batch.commit();
                                console.log(`LOG: ${pagamentosFuturosPendentesExcluidos} pagamentos futuros/pendentes excluídos e ${pagamentosMantidosDesvinculados} pagamentos mantidos/desvinculados para funcionário ${funcionarioId}.`);
                                pagamentosManipulados = true;
                            } else {
                                console.log(`LOG: Nenhum pagamento encontrado para o funcionário ${funcionarioId} para excluir ou desvincular (Opção SIM).`);
                            }
                        } else {
                            // Opção NÃO: Apenas desvincular todos os pagamentos
                            const pagamentosFuncQuery = query(collection(db, "pagamentos"), where("funcionarioId", "==", funcionarioId));
                            const pagamentosFuncSnapshot = await getDocs(pagamentosFuncQuery);
                            if (!pagamentosFuncSnapshot.empty) {
                                const batchPagamentosDesvincular = writeBatch(db);
                                pagamentosFuncSnapshot.forEach(docPg => {
                                    batchPagamentosDesvincular.update(docPg.ref, { funcionarioId: null });
                                });
                                await batchPagamentosDesvincular.commit();
                                console.log(`LOG: ${pagamentosFuncSnapshot.size} pagamentos desvinculados (opção NÃO selecionada para excluir futuros) para funcionário ${funcionarioId}.`);
                                pagamentosManipulados = true;
                            } else {
                                console.log(`LOG: Nenhum pagamento encontrado para desvincular do funcionário ${funcionarioId} (Opção NÃO).`);
                            }
                        }

                        // Excluir o documento do funcionário
                        await deleteDoc(doc(db, "funcionarios", funcionarioId));
                        alert(`Funcionário "${funcionarioNome}" excluído com sucesso! ${pagamentosManipulados ? 'Operações nos pagamentos também foram realizadas.' : ''}`);
                        todosFuncionariosArray = todosFuncionariosArray.filter(f => f.id !== funcionarioId);
                        aplicarFiltrosFuncionarios();
                        // Se a lista de todos os pagamentos estiver visível, recarregá-la
                        if (todosPagamentosContainer.style.display === 'block') {
                            await carregarTodosPagamentosGlobais();
                        }

                    } catch (err) {
                        console.error("Erro ao excluir funcionário e/ou manipular pagamentos:", err);
                        alert("Ocorreu um erro ao tentar excluir o funcionário.");
                    } finally {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Del';
                    }
                });
            });
        }


        function abrirModalCadastroFuncionario() {
            formFuncionarioModal.reset(); funcionarioIdInput.value = ''; modalFuncionarioTitle.textContent = 'Novo Funcionário';
            parcelasContainer.innerHTML = ''; toggleSalarioDiasFields(''); parcelasValidationErrorDiv.style.display = 'none';
            atualizarTotalPercentual(); funcionarioModal.style.display = 'block'; nomeCompletoInput.focus();
        }
        async function abrirModalEdicaoFuncionario(funcionarioId) {
            if (!db) { alert("Erro de conexão."); return; }
            console.log("LOG: Tentando abrir modal de edição para ID:", funcionarioId);
            try {
                const funcRef = doc(db, "funcionarios", funcionarioId); const funcSnap = await getDoc(funcRef);
                if (!funcSnap.exists()) { alert("Funcionário não encontrado no banco de dados. Pode ter sido excluído."); await carregarFuncionarios(); return; }
                const funcionario = { id: funcSnap.id, ...funcSnap.data() }; console.log("LOG: Dados do funcionário para edição:", funcionario);
                formFuncionarioModal.reset(); funcionarioIdInput.value = funcionario.id; modalFuncionarioTitle.textContent = 'Editar Funcionário';
                nomeCompletoInput.value = funcionario.nomeCompleto || ''; telefoneInput.value = funcionario.telefone || ''; emailInput.value = funcionario.email || '';
                tipoFuncionarioSelect.value = funcionario.tipo || '';
                toggleSalarioDiasFields(funcionario.tipo);
                if (funcionario.tipo === 'fixo') {
                    console.log("LOG: Preenchendo dados de funcionário fixo para edição...");
                    salarioMensalInput.value = funcionario.salarioMensal || ''; parcelasContainer.innerHTML = '';
                    if (funcionario.parcelasPagamento && Array.isArray(funcionario.parcelasPagamento) && funcionario.parcelasPagamento.length > 0) {
                        console.log("LOG: Adicionando parcelas existentes:", funcionario.parcelasPagamento);
                        funcionario.parcelasPagamento.forEach(p => { adicionarNovaParcelaInput(p.dia, p.percentual); });
                    } else { console.log("LOG: Funcionário fixo sem parcelas, adicionando campo vazio."); adicionarNovaParcelaInput(); }
                    atualizarTotalPercentual();
                }
                parcelasValidationErrorDiv.style.display = 'none'; funcionarioModal.style.display = 'block'; nomeCompletoInput.focus();
            } catch (error) { console.error("Erro ao carregar dados do funcionário para edição:", error); alert("Erro ao carregar dados para edição. Verifique o console.");}
        }
        function toggleSalarioDiasFields(tipo) {
            const isFixo = tipo === 'fixo'; salarioFixoGroup.style.display = isFixo ? 'flex' : 'none'; parcelasPagamentoGroup.style.display = isFixo ? 'block' : 'none';
            if (!isFixo) { parcelasContainer.innerHTML = ''; salarioMensalInput.removeAttribute('required'); salarioMensalInput.value = ''; atualizarTotalPercentual(); parcelasValidationErrorDiv.style.display = 'none';
            } else {
                salarioMensalInput.setAttribute('required', 'required');
                if (!funcionarioIdInput.value && parcelasContainer.children.length === 0) { adicionarNovaParcelaInput(); }
                else if (funcionarioIdInput.value && parcelasContainer.children.length === 0 && tipoFuncionarioSelect.value === 'fixo') { adicionarNovaParcelaInput(); }
                atualizarTotalPercentual();
            }
        }
        function adicionarNovaParcelaInput(dia = '', percentual = '') {
            const divPair = document.createElement('div'); divPair.className = 'parcela-input-pair';
            divPair.innerHTML = `<input type="number" class="parcela-dia form-control form-control-sm" placeholder="Dia" min="1" max="31" required value="${dia}"><input type="number" class="parcela-percentual form-control form-control-sm" placeholder="%" min="0.01" max="100" step="0.01" required value="${percentual}"><button type="button" class="btn-danger btn-sm btn-remove-parcela" title="Remover Parcela"><i class="fas fa-times"></i></button>`;
            parcelasContainer.appendChild(divPair);
            const diaInput = divPair.querySelector('.parcela-dia'); const percentualInput = divPair.querySelector('.parcela-percentual'); const removeBtn = divPair.querySelector('.btn-remove-parcela');
            diaInput.addEventListener('input', () => { diaInput.style.borderColor = ''; atualizarTotalPercentual(); });
            percentualInput.addEventListener('input', () => { percentualInput.style.borderColor = ''; atualizarTotalPercentual(); });
            removeBtn.addEventListener('click', (e) => { e.target.closest('.parcela-input-pair').remove(); atualizarTotalPercentual(); });
            atualizarTotalPercentual();
        }
        function atualizarTotalPercentual() {
            if (parcelasPagamentoGroup.style.display === 'none') { parcelasTotalPercentualSpan.textContent = ''; parcelasTotalPercentualSpan.className = ''; parcelasValidationErrorDiv.style.display = 'none'; return; }
            let total = 0; const percentuaisInputs = parcelasContainer.querySelectorAll('.parcela-percentual');
            percentuaisInputs.forEach(input => { total += parseFloat(input.value) || 0; });
            parcelasTotalPercentualSpan.textContent = `Total: ${total.toFixed(2)}%`;
            const isValidTotal = Math.abs(total - 100) < 0.001;
            if (isValidTotal && total > 0) { parcelasTotalPercentualSpan.className = 'valid'; }
            else if (total === 0 && percentuaisInputs.length === 0) { parcelasTotalPercentualSpan.textContent = 'Nenhuma parcela adicionada.'; parcelasTotalPercentualSpan.className = ''; }
            else { parcelasTotalPercentualSpan.className = 'invalid'; }
        }
        function coletarEValidarParcelas() {
            parcelasValidationErrorDiv.style.display = 'none'; parcelasValidationErrorDiv.textContent = '';
            parcelasContainer.querySelectorAll('input').forEach(input => input.style.borderColor = '');
            const parcelas = []; const diasAdicionados = new Set(); let somaPercentuais = 0; let erro = null;
            const inputsPairs = parcelasContainer.querySelectorAll('.parcela-input-pair');
            if (inputsPairs.length === 0 && tipoFuncionarioSelect.value === 'fixo') { erro = "Para funcionário Fixo, adicione pelo menos uma parcela de pagamento."; }
            inputsPairs.forEach((pair, index) => { if (erro) return; const diaInput = pair.querySelector('.parcela-dia'); const percentualInput = pair.querySelector('.parcela-percentual'); const dia = parseInt(diaInput.value); const percentual = parseFloat(percentualInput.value); if (isNaN(dia) || dia < 1 || dia > 31) { erro = `Dia inválido (${diaInput.value || 'vazio'}) na Parcela ${index + 1}.`; diaInput.style.borderColor = 'var(--danger-color)'; diaInput.focus(); } else if (diasAdicionados.has(dia)) { erro = `Dia ${dia} está duplicado na Parcela ${index + 1}.`; diaInput.style.borderColor = 'var(--danger-color)'; diaInput.focus(); } else if (isNaN(percentual) || percentual <= 0 || percentual > 100) { erro = `Percentual inválido (${percentualInput.value || 'vazio'}) na Parcela ${index + 1}.`; percentualInput.style.borderColor = 'var(--danger-color)'; percentualInput.focus(); } else { diasAdicionados.add(dia); somaPercentuais += percentual; parcelas.push({ dia: dia, percentual: parseFloat(percentual.toFixed(2)) }); } });
            if (!erro && inputsPairs.length > 0 && Math.abs(somaPercentuais - 100) > 0.001) { erro = `A soma dos percentuais (${somaPercentuais.toFixed(2)}%) deve ser exatamente 100%.`; parcelasContainer.querySelectorAll('.parcela-percentual').forEach(inp => inp.style.borderColor = 'var(--danger-color)');}
            if (erro) { parcelasValidationErrorDiv.textContent = erro; parcelasValidationErrorDiv.style.display = 'block'; return null; }
            parcelas.sort((a, b) => a.dia - b.dia); return parcelas;
        }
        btnAddParcela.addEventListener('click', () => adicionarNovaParcelaInput());
        tipoFuncionarioSelect.addEventListener('change', (e) => { toggleSalarioDiasFields(e.target.value); });

        async function processarSalvamentoFuncionario() {
            if (!db) { alert("Erro de conexão com o banco de dados. Não é possível salvar."); return; }
            const id = funcionarioIdInput.value; const nomeCompleto = nomeCompletoInput.value.trim(); const telefone = telefoneInput.value.trim();
            const email = emailInput.value.trim(); const tipo = tipoFuncionarioSelect.value;
            let salarioMensal = tipo === 'fixo' ? parseFloat(salarioMensalInput.value) || 0 : null;
            let parcelasPagamento = null;
            if (!nomeCompleto || !tipo) { alert("Nome completo e Tipo são obrigatórios."); return; }
            if (tipo === 'fixo') {
                if (isNaN(salarioMensal) || salarioMensal <= 0) { alert("Informe um salário mensal válido maior que zero para funcionário Fixo."); salarioMensalInput.focus(); salarioMensalInput.style.borderColor = 'var(--danger-color)'; return; }
                else { salarioMensalInput.style.borderColor = ''; }
                parcelasPagamento = coletarEValidarParcelas(); if (!parcelasPagamento) return;
            } else { salarioMensal = null; parcelasPagamento = null; }
            salvarFuncionarioBtn.disabled = true; salvarFuncionarioBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            const dadosFuncionario = { nomeCompleto, telefone: telefone || null, email: email || null, tipo, salarioMensal, parcelasPagamento };
            try {
                if (id) { const funcionarioRef = doc(db, "funcionarios", id); await updateDoc(funcionarioRef, dadosFuncionario); alert("Funcionário atualizado com sucesso!"); }
                else { dadosFuncionario.createdAt = Timestamp.now(); await addDoc(collection(db, "funcionarios"), dadosFuncionario); alert(`Funcionário "${nomeCompleto}" cadastrado com sucesso!`); }
                funcionarioModal.style.display = 'none'; formFuncionarioModal.reset(); parcelasContainer.innerHTML = ''; toggleSalarioDiasFields('');
                await carregarFuncionarios();
            } catch (error) { console.error("Erro ao salvar funcionário:", error); alert(`Ocorreu um erro ao salvar o funcionário: ${error.message}`);
            } finally { salvarFuncionarioBtn.disabled = false; salvarFuncionarioBtn.innerHTML = 'Salvar'; }
        }
        formFuncionarioModal.addEventListener('submit', (e) => { e.preventDefault(); console.log("LOG: Submit do formulário de funcionário acionado."); processarSalvamentoFuncionario(); });

        // Geração de Pagamentos Recorrentes (Fixos) - COM NOME DO FUNCIONÁRIO NA DESCRIÇÃO
        async function generateRecurringPayments() {
             if (!db) { console.error("LOG: Firestore não inicializado, geração de pagamentos recorrentes (fixo) cancelada."); return; }
            console.log("LOG: Verificando/Gerando pagamentos recorrentes para funcionários fixos...");
            const today = new Date(); today.setHours(0, 0, 0, 0); const currentYear = today.getFullYear(); const currentMonth = today.getMonth();
            const monthsToGenerateAhead = 2; const limitDate = new Date(currentYear, currentMonth + monthsToGenerateAhead + 1, 0); limitDate.setHours(23, 59, 59, 999);
            const fixedEmployeesWithSchedule = todosFuncionariosArray.filter(f => f.tipo === 'fixo' && f.salarioMensal != null && f.salarioMensal > 0 && f.parcelasPagamento && Array.isArray(f.parcelasPagamento) && f.parcelasPagamento.length > 0);
            if (fixedEmployeesWithSchedule.length === 0) { console.log("LOG: Nenhum funcionário fixo elegível para geração de pagamentos recorrentes."); return; }
            let mainBatch = writeBatch(db); let generatedInCurrentBatch = 0; const MAX_BATCH_WRITES = 490;
            for (const funcionario of fixedEmployeesWithSchedule) {
                if (!funcionario.id || !funcionario.nomeCompleto) { console.warn("LOG: Funcionário inválido pulado na geração de recorrentes:", funcionario); continue; }
                const salarioMensal = funcionario.salarioMensal;
                for (let monthOffset = 0; monthOffset <= monthsToGenerateAhead; monthOffset++) {
                    const targetMonthDate = new Date(currentYear, currentMonth + monthOffset, 1); const targetYear = targetMonthDate.getFullYear(); const targetMonthIndex = targetMonthDate.getMonth();
                    for (const parcela of funcionario.parcelasPagamento) {
                        const dia = parcela.dia; const percentual = parcela.percentual;
                        if (isNaN(dia) || isNaN(percentual) || percentual <= 0) { console.warn(`LOG: Parcela inválida para ${funcionario.nomeCompleto}, pulando: Dia=${dia}, Percentual=${percentual}`); continue; }
                        const lastDayOfMonth = new Date(targetYear, targetMonthIndex + 1, 0).getDate(); const paymentDay = Math.min(dia, lastDayOfMonth);
                        const paymentDate = new Date(targetYear, targetMonthIndex, paymentDay); paymentDate.setHours(0,0,0,0);
                        if (paymentDate < today || paymentDate > limitDate) continue;
                        const paymentDateString = dateToYYYYMMDD(paymentDate); const valorParcela = parseFloat(((salarioMensal * percentual) / 100).toFixed(2));
                        if (valorParcela <= 0) continue;
                        // *** NOME DO FUNCIONÁRIO ADICIONADO AQUI ***
                        const descricao = `Salário Fixo (${funcionario.nomeCompleto}) Ref. ${getMonthName(targetMonthIndex)}/${targetYear} (Dia ${dia} - ${percentual.toFixed(2).replace('.',',')}%)`;
                        const uniqueCheckQuery = query(collection(db, "pagamentos"), where("funcionarioId", "==", funcionario.id), where("dataPagamento", "==", paymentDateString), where("tipoLancamentoFunc", "==", "salario"), where("generatedByRecurrence", "==", true));
                        try {
                            const existingPaymentsSnapshot = await getDocs(uniqueCheckQuery);
                            const alreadyExists = existingPaymentsSnapshot.docs.some(doc => doc.data().descricao === descricao && Math.abs(doc.data().valor - valorParcela) < 0.01);
                            if (!alreadyExists) {
                                console.log(`LOG: Gerando PENDENTE (Fixo): ${funcionario.nomeCompleto} - ${descricao} - ${formatarValorBRL(valorParcela)} em ${formatarDataExibicao(paymentDateString)}`);
                                const newPaymentRef = doc(collection(db, "pagamentos"));
                                mainBatch.set(newPaymentRef, { descricao, valor: valorParcela, dataPagamento: paymentDateString, pago: false, funcionarioId: funcionario.id, tipoLancamentoFunc: 'salario', generatedByRecurrence: true, createdAt: Timestamp.now() });
                                generatedInCurrentBatch++;
                                if (generatedInCurrentBatch >= MAX_BATCH_WRITES) { console.warn("LOG: Limite do batch (dentro do loop) atingido, commitando..."); await mainBatch.commit(); mainBatch = writeBatch(db); generatedInCurrentBatch = 0; }
                            }
                        } catch(queryError) { console.error(`Erro ao verificar pagamentos existentes para ${funcionario.nomeCompleto}:`, queryError); }
                    }
                }
            }
            if (generatedInCurrentBatch > 0) { try { await mainBatch.commit(); console.log(`LOG: Batch final de ${generatedInCurrentBatch} lançamentos recorrentes (fixo) gerado.`); } catch (error) { console.error("Erro ao commitar batch final de pagamentos recorrentes (fixo):", error); alert("Erro ao salvar pagamentos recorrentes gerados."); }}
            else { console.log("LOG: Nenhum lançamento recorrente (fixo) novo para gerar no batch final.");}
        }

        // Histórico de Pagamentos - COM MAIS LOGS E TRATAMENTO DE ÍNDICE
        async function abrirModalHistoricoPagamentos(funcionario) {
            if (!funcionario || !funcionario.id) { alert("Erro: Dados do funcionário inválidos para carregar histórico."); console.error("LOG: Tentativa de abrir histórico com funcionário inválido:", funcionario); return; }
            if (!db) { console.error("LOG: Firestore não inicializado. Histórico de pagamentos cancelado."); return; }
            console.log(`LOG: Abrindo histórico de pagamentos para: ${funcionario.nomeCompleto} (ID: ${funcionario.id})`);
            historyFuncionarioNomeSpan.textContent = funcionario.nomeCompleto || 'Funcionário'; paymentList.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Carregando histórico...</li>'; emptyHistoryMessage.style.display = 'none'; paymentFuncionarioIdInput.value = funcionario.id;
            const newAddBtn = btnAddPayment.cloneNode(true); btnAddPayment.parentNode.replaceChild(newAddBtn, btnAddPayment); btnAddPayment = newAddBtn; btnAddPayment.onclick = () => abrirModalAddPayment(funcionario.id);
            try {
                console.log(`LOG: Executando query para pagamentos do funcionarioId: ${funcionario.id}`);
                const q = query(collection(db, "pagamentos"), where("funcionarioId", "==", funcionario.id), orderBy("dataPagamento", "desc"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                console.log(`LOG: Query de pagamentos concluída. Vazia: ${querySnapshot.empty}, Tamanho: ${querySnapshot.size}`);
                paymentList.innerHTML = '';
                if (querySnapshot.empty) { console.log("LOG: Nenhum pagamento encontrado para este funcionário."); emptyHistoryMessage.style.display = 'block'; }
                else {
                    querySnapshot.forEach(doc => {
                        const pagamento = doc.data(); console.log("LOG: Processando pagamento do histórico:", doc.id, pagamento);
                        const li = document.createElement('li'); li.dataset.paymentId = doc.id;
                        let tipoTexto = 'Lanç.'; if(pagamento.tipoLancamentoFunc === 'salario') tipoTexto = 'Salário'; else if(pagamento.tipoLancamentoFunc === 'adiantamento') tipoTexto = 'Adiant.'; else if(pagamento.tipoLancamentoFunc === 'freelancer') tipoTexto = 'Freelance';
                        const statusClass = pagamento.pago ? 'status-pago' : 'status-pendente'; const statusIcon = pagamento.pago ? 'fa-check-circle' : 'fa-clock'; const statusText = pagamento.pago ? 'Pago' : 'Pendente';
                        let statusToggleButton = ''; if (pagamento.pago) { statusToggleButton = `<button class="btn-warning btn-sm btn-toggle-paid" data-target-status="false" title="Marcar Pendente"><i class="fas fa-undo"></i> Pendente</button>`; } else { statusToggleButton = `<button class="btn-success btn-sm btn-toggle-paid" data-target-status="true" title="Marcar Pago"><i class="fas fa-check"></i> Pago</button>`;}
                        li.innerHTML = `<div class="payment-details"><strong>${tipoTexto}:</strong> <span class="value">${formatarValorBRL(pagamento.valor || 0)}</span> <span class="date">(${formatarDataExibicao(pagamento.dataPagamento)})</span> <span class="${statusClass}"><i class="fas ${statusIcon}"></i> ${statusText}</span> ${pagamento.generatedByRecurrence ? '<i class="fas fa-sync-alt" title="Gerado Automaticamente" style="color: var(--info-color); margin-left: 5px; font-size: 0.8em;"></i>': ''} <span class="description">${pagamento.descricao || 'Sem descrição'}</span></div><div class="payment-actions">${statusToggleButton} <button class="btn-danger btn-sm btn-delete-payment" title="Excluir Lançamento"><i class="fas fa-trash-alt"></i> Del</button></div>`; paymentList.appendChild(li);
                    });
                    addListenersBotoesPagamento();
                }
            } catch (error) {
                console.error("ERRO CRÍTICO ao carregar histórico de pagamentos:", error);
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    const errorMsg = `ERRO: A consulta de pagamentos requer um índice no Firestore. Abra o console do navegador (F12) para ver o link de criação do índice e tente novamente após criá-lo. Detalhe: ${error.message}`;
                    paymentList.innerHTML = `<li style="color: var(--danger-color); white-space: normal;">${errorMsg}</li>`;
                    alert(errorMsg.substring(0, 250));
                } else { paymentList.innerHTML = '<li style="color: var(--danger-color);">Erro ao carregar histórico. Tente novamente.</li>';}
            } finally { paymentHistoryModal.style.display = 'block'; }
        }
        function addListenersBotoesPagamento() {
            if (!db) return; const paymentItems = paymentList.querySelectorAll('li[data-payment-id]');
            paymentItems.forEach(li => { const paymentId = li.dataset.paymentId; const deleteBtn = li.querySelector('.btn-delete-payment'); if (deleteBtn) { const newDeleteBtn = deleteBtn.cloneNode(true); deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn); newDeleteBtn.addEventListener('click', async (e) => { const currentLi = e.currentTarget.closest('li'); const currentPaymentId = currentLi.dataset.paymentId; const descricao = currentLi.querySelector('.description')?.textContent || 'Lançamento'; if (!confirm(`Excluir lançamento "${descricao}"?`)) return; const button = e.currentTarget; button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; try { await deleteDoc(doc(db, "pagamentos", currentPaymentId)); currentLi.remove(); if (paymentList.children.length === 0) { emptyHistoryMessage.style.display = 'block'; } } catch (err) { console.error("Erro ao excluir lançamento:", err); alert("Erro ao excluir."); button.disabled = false; button.innerHTML = '<i class="fas fa-trash-alt"></i> Del';}}); }
            const toggleBtn = li.querySelector('.btn-toggle-paid'); if(toggleBtn) { const newToggleBtn = toggleBtn.cloneNode(true); toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn); newToggleBtn.addEventListener('click', async (e) => { const currentLi = e.currentTarget.closest('li'); const currentPaymentId = currentLi.dataset.paymentId; const targetStatus = e.currentTarget.dataset.targetStatus === 'true'; const button = e.currentTarget; button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; try { const paymentRef = doc(db, "pagamentos", currentPaymentId); await updateDoc(paymentRef, { pago: targetStatus }); const statusSpan = currentLi.querySelector('.status-pago, .status-pendente'); const statusIconElement = statusSpan.querySelector('i'); let newButtonHTML = ''; if (targetStatus) { statusSpan.className = 'status-pago'; statusIconElement.className = 'fas fa-check-circle'; statusSpan.textContent = ''; statusSpan.appendChild(statusIconElement); statusSpan.append(' Pago'); newButtonHTML = `<button class="btn-warning btn-sm btn-toggle-paid" data-target-status="false" title="Marcar Pendente"><i class="fas fa-undo"></i> Pendente</button>`; } else { statusSpan.className = 'status-pendente'; statusIconElement.className = 'fas fa-clock'; statusSpan.textContent = ''; statusSpan.appendChild(statusIconElement); statusSpan.append(' Pendente'); newButtonHTML = `<button class="btn-success btn-sm btn-toggle-paid" data-target-status="true" title="Marcar Pago"><i class="fas fa-check"></i> Pago</button>`;} const actionsDiv = currentLi.querySelector('.payment-actions'); const oldToggleBtn = actionsDiv.querySelector('.btn-toggle-paid'); if(oldToggleBtn) { oldToggleBtn.insertAdjacentHTML('afterend', newButtonHTML); oldToggleBtn.remove(); addListenersBotoesPagamento();}} catch(err) { console.error("Erro ao atualizar status:", err); alert("Erro ao atualizar status."); button.disabled = false; button.innerHTML = targetStatus ? (targetStatus ? '<i class="fas fa-check"></i> Pago' : '<i class="fas fa-undo"></i> Pendente') : (targetStatus ? '<i class="fas fa-check"></i> Pago' : '<i class="fas fa-undo"></i> Pendente');}});}});}

        // Modal Adicionar Pagamento - FUNÇÃO REVISADA E CHECKBOX CORRIGIDO
        function abrirModalAddPayment(funcionarioId) {
            formAddPayment.reset(); paymentFuncionarioIdInput.value = funcionarioId;
            paymentDataInput.value = getTodayDateString();
            paymentIsPaidCheckbox.checked = false; // PADRÃO PARA PENDENTE
            console.log("LOG: Abrindo modal de add pagamento para funcionario ID:", funcionarioId);
            const funcionario = todosFuncionariosArray.find(f => f.id === funcionarioId);
            paymentTipoSelect.querySelectorAll('option').forEach(opt => opt.disabled = false);
            if (funcionario) {
                console.log("LOG: Funcionário encontrado para add pagto:", funcionario.nomeCompleto, "- Tipo:", funcionario.tipo);
                if (funcionario.tipo === 'fixo') { paymentTipoSelect.querySelector('option[value="freelancer"]').disabled = true; paymentTipoSelect.value = 'salario'; }
                else if (funcionario.tipo === 'freelancer') { paymentTipoSelect.querySelector('option[value="salario"]').disabled = true; paymentTipoSelect.value = 'freelancer'; }
                else { paymentTipoSelect.querySelector('option[value="salario"]').disabled = true; paymentTipoSelect.querySelector('option[value="freelancer"]').disabled = true; paymentTipoSelect.value = 'adiantamento'; }
            } else { console.warn("LOG: Funcionário NÃO encontrado ao abrir modal de pagamento. ID:", funcionarioId); paymentTipoSelect.value = 'adiantamento'; }
            console.log("LOG: paymentTipoSelect.value após config:", paymentTipoSelect.value);
            console.log("LOG: Opção 'freelancer' disabled:", paymentTipoSelect.querySelector('option[value="freelancer"]').disabled);
            console.log("LOG: Opção 'salario' disabled:", paymentTipoSelect.querySelector('option[value="salario"]').disabled);
            addPaymentModal.style.display = 'block'; paymentDescricaoInput.focus();
        }
        formAddPayment.addEventListener('submit', async (e) => {
            e.preventDefault(); if (!db) {alert("Erro de conexão."); return;}
            salvarPagamentoBtn.disabled = true; salvarPagamentoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            const funcionarioId = paymentFuncionarioIdInput.value; const tipoLancamentoFunc = paymentTipoSelect.value;
            const descricao = paymentDescricaoInput.value.trim(); const valor = parseFloat(paymentValorInput.value) || 0;
            const dataPagamento = paymentDataInput.value; const isPaid = paymentIsPaidCheckbox.checked;
            if (!funcionarioId || !tipoLancamentoFunc || !descricao || valor <= 0 || !dataPagamento) { alert("Preencha todos os campos corretamente (Valor > 0, Data válida)."); salvarPagamentoBtn.disabled = false; salvarPagamentoBtn.innerHTML = 'Registrar Lançamento'; return; }
            try {
                await addDoc(collection(db, "pagamentos"), { descricao, valor, dataPagamento, pago: isPaid, funcionarioId, tipoLancamentoFunc, generatedByRecurrence: false, createdAt: Timestamp.now() });
                console.log(`LOG: Lançamento de ${tipoLancamentoFunc} R$${valor} para func ${funcionarioId} registrado como ${isPaid ? 'Pago' : 'Pendente'}`);
                addPaymentModal.style.display = 'none'; formAddPayment.reset();
                if (paymentHistoryModal.style.display === 'block' && funcionarioSelecionadoParaPagamento && funcionarioSelecionadoParaPagamento.id === funcionarioId) { await abrirModalHistoricoPagamentos(funcionarioSelecionadoParaPagamento); }
                 // Se a lista geral estiver visível, atualize-a também
                if (todosPagamentosContainer.style.display === 'block') { await carregarTodosPagamentosGlobais(); }
            } catch (error) { console.error("Erro ao registrar lançamento financeiro:", error); alert(`Ocorreu um erro ao registrar o lançamento: ${error.message}`);
            } finally { salvarPagamentoBtn.disabled = false; salvarPagamentoBtn.innerHTML = 'Registrar Lançamento'; }
        });

        // Listeners Gerais de Modais e Filtros
        closeModalsBtns.forEach(btn => { btn.addEventListener('click', (e) => { const modalId = e.target.dataset.modalId || e.target.closest('.close-modal-btn')?.dataset.modalId; if (modalId) { const modalToClose = document.getElementById(modalId); if (modalToClose) { modalToClose.style.display = 'none'; if (modalId === 'payment-history-modal') { funcionarioSelecionadoParaPagamento = null;} if (modalId === 'funcionario-modal') { parcelasValidationErrorDiv.style.display = 'none'; parcelasContainer.querySelectorAll('input').forEach(input => input.style.borderColor = '');}}}});});
        window.addEventListener('click', (event) => { if (event.target == funcionarioModal) { funcionarioModal.style.display = 'none'; parcelasValidationErrorDiv.style.display = 'none'; parcelasContainer.querySelectorAll('input').forEach(input => input.style.borderColor = '');} if (event.target == paymentHistoryModal) { paymentHistoryModal.style.display = 'none'; funcionarioSelecionadoParaPagamento = null; } if (event.target == addPaymentModal) { addPaymentModal.style.display = 'none'; }});

        // Funções e Listeners para Lista Geral de Pagamentos
        async function carregarTodosPagamentosGlobais() {
            if (!db) { loadingAllPaymentsMessage.textContent = "Erro de conexão."; loadingAllPaymentsMessage.style.display = 'block'; return; }
            loadingAllPaymentsMessage.style.display = 'block'; emptyAllPaymentsMessage.style.display = 'none'; tabelaTodosPagamentosBody.innerHTML = '';
            let todosPagamentosGlobaisArray = [];
            try {
                const q = query(collection(db, "pagamentos"), orderBy("dataPagamento", "desc"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => { todosPagamentosGlobaisArray.push({ id: doc.id, ...doc.data() }); });
                console.log(`LOG: ${todosPagamentosGlobaisArray.length} lançamentos globais carregados.`);
                renderizarTabelaPagamentosGlobais(todosPagamentosGlobaisArray);
            } catch (error) {
                console.error("ERRO ao carregar todos os pagamentos:", error);
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    const errorMsgGlobal = `ERRO: A consulta de 'todos os pagamentos' requer um índice. Por favor, verifique o console do navegador para um link para criar o índice no Firebase e tente novamente. Detalhe: ${error.message}`;
                    emptyAllPaymentsMessage.innerHTML = `<span style="color: var(--danger-color); white-space: normal;">${errorMsgGlobal}</span>`;
                    alert(errorMsgGlobal.substring(0, 250));
                } else { emptyAllPaymentsMessage.textContent = "Erro ao carregar lançamentos."; }
                emptyAllPaymentsMessage.style.display = 'block';
            } finally { loadingAllPaymentsMessage.style.display = 'none'; }
        }
        function renderizarTabelaPagamentosGlobais(pagamentos) {
            tabelaTodosPagamentosBody.innerHTML = '';
            if (pagamentos.length === 0) { emptyAllPaymentsMessage.style.display = 'block'; emptyAllPaymentsMessage.textContent = "Nenhum lançamento financeiro encontrado."; return; }
            emptyAllPaymentsMessage.style.display = 'none';
            pagamentos.forEach(pgto => {
                const tr = document.createElement('tr'); tr.dataset.paymentId = pgto.id; if(pgto.funcionarioId) tr.dataset.funcionarioRefId = pgto.funcionarioId;
                const funcionario = todosFuncionariosArray.find(f => f.id === pgto.funcionarioId);
                const nomeFuncionario = funcionario ? funcionario.nomeCompleto : (pgto.funcionarioId ? `Funcionário (ID: ${pgto.funcionarioId.substring(0,5)}...)` : 'Avulso/Excluído');
                let tipoTexto = pgto.tipoLancamentoFunc || 'N/A'; if(tipoTexto === 'salario') tipoTexto = 'Salário'; else if(tipoTexto === 'adiantamento') tipoTexto = 'Adiant.'; else if(tipoTexto === 'freelancer') tipoTexto = 'Freelance';
                const statusClass = pgto.pago ? 'status-pago' : 'status-pendente'; const statusIcon = pgto.pago ? 'fa-check-circle' : 'fa-clock'; const statusText = pgto.pago ? 'Pago' : 'Pendente';
                const dataCriacaoRaw = pgto.createdAt; let dataCriacaoFormatada = 'N/A';
                if (dataCriacaoRaw) { if (dataCriacaoRaw.toDate) { dataCriacaoFormatada = formatarDataExibicao(dateToYYYYMMDD(dataCriacaoRaw.toDate()));} else if (typeof dataCriacaoRaw === 'string') { dataCriacaoFormatada = formatarDataExibicao(dataCriacaoRaw.substring(0,10));}}
                tr.innerHTML = `
                    <td class="col-funcionario-pgto">${nomeFuncionario}</td> <td class="col-tipo-pgto">${tipoTexto}</td>
                    <td class="col-descricao-pgto">${pgto.descricao || 'Sem descrição'} ${pgto.generatedByRecurrence ? '<i class="fas fa-sync-alt" title="Gerado Automaticamente" style="color: var(--info-color); font-size: 0.8em;"></i>': ''}</td>
                    <td class="col-valor-pgto">${formatarValorBRL(pgto.valor)}</td> <td class="col-data-pgto">${formatarDataExibicao(pgto.dataPagamento)}</td>
                    <td class="col-status-pgto"><span class="${statusClass}"><i class="fas ${statusIcon}"></i> ${statusText}</span></td>
                    <td class="col-criado-pgto">${dataCriacaoFormatada}</td>
                    <td class="col-actions">
                        <button class="btn-sm ${pgto.pago ? 'btn-warning' : 'btn-success'} btn-toggle-paid-global" data-target-status="${!pgto.pago}" title="${pgto.pago ? 'Marcar Pendente' : 'Marcar Pago'}"><i class="fas ${pgto.pago ? 'fa-undo' : 'fa-check'}"></i></button>
                        <button class="btn-danger btn-sm btn-delete-payment-global" title="Excluir Lançamento"><i class="fas fa-trash-alt"></i></button>
                    </td>`;
                tabelaTodosPagamentosBody.appendChild(tr);
            });
            addListenersBotoesTabelaPagamentosGlobais();
        }
        function addListenersBotoesTabelaPagamentosGlobais() {
            if (!db) return;
            document.querySelectorAll('#tabela-todos-pagamentos .btn-delete-payment-global').forEach(btn => { const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.addEventListener('click', async (e) => { const paymentId = e.currentTarget.closest('tr').dataset.paymentId; const descricao = e.currentTarget.closest('tr').cells[2].textContent.trim(); if (!confirm(`Excluir lançamento: "${descricao}"?`)) return; e.currentTarget.disabled = true; e.currentTarget.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; try { await deleteDoc(doc(db, "pagamentos", paymentId)); await carregarTodosPagamentosGlobais(); } catch (err) { console.error("Erro ao excluir lançamento global:", err); alert("Erro ao excluir."); e.currentTarget.disabled = false; e.currentTarget.innerHTML = '<i class="fas fa-trash-alt"></i>'; }});});
            document.querySelectorAll('#tabela-todos-pagamentos .btn-toggle-paid-global').forEach(btn => { const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.addEventListener('click', async (e) => { const paymentId = e.currentTarget.closest('tr').dataset.paymentId; const targetStatus = e.currentTarget.dataset.targetStatus === 'true'; e.currentTarget.disabled = true; e.currentTarget.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; try { const paymentRef = doc(db, "pagamentos", paymentId); await updateDoc(paymentRef, { pago: targetStatus }); await carregarTodosPagamentosGlobais(); } catch (err) { console.error("Erro ao mudar status pagamento global:", err); alert("Erro ao mudar status."); }});});
        }
        if (btnViewAllPayments) { btnViewAllPayments.addEventListener('click', async () => { todosPagamentosContainer.style.display = 'block'; await carregarTodosPagamentosGlobais(); });}
        if (btnCloseAllPaymentsView) { btnCloseAllPaymentsView.addEventListener('click', () => { todosPagamentosContainer.style.display = 'none'; });}

        // --- Inicialização ---
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("LOG: DOM carregado. Inicializando Cadastro de Funcionários...");
            if (!db) { console.warn("LOG: Inicialização adiada: Firestore não conectado."); return; }
            await carregarFuncionarios();
            buscaFuncionarioInput.addEventListener('input', aplicarFiltrosFuncionarios);
            filtroTipoSelect.addEventListener('change', aplicarFiltrosFuncionarios);
            btnLimparFiltros.addEventListener('click', () => { buscaFuncionarioInput.value = ''; filtroTipoSelect.value = ''; aplicarFiltrosFuncionarios(); });
            if (btnAddFuncionario && !btnAddFuncionario.disabled) { btnAddFuncionario.addEventListener('click', abrirModalCadastroFuncionario); }
            else if (!btnAddFuncionario) {console.error("Botão 'Novo Funcionário' não encontrado.")}
            else {console.warn("Botão 'Novo Funcionário' desabilitado (provavelmente falha de conexão).")}
            console.log("LOG: Aplicação de Cadastro de Funcionários inicializada e pronta.");
        });
    </script>
</body>
</html>